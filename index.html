<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›…ä¸½æ´ç ”å‘ä¸­å¿ƒè¯„åˆ†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .mobile-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .admin-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .panel-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #2c3e50;
            text-align: center;
            font-weight: 700;
        }
        
        .share-link {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            margin: 20px 0;
            border: 2px dashed #3498db;
            font-size: 0.9rem;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            margin: 5px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .navbar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #3498db;
            color: #3498db;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-btn.active {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .mobile-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .page-header {
            background: linear-gradient(135deg, #3498db 0%, #8e44ad 100%);
            color: white;
            padding: 30px 25px;
            text-align: center;
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .group-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 25px 0;
        }
        
        .group-btn {
            background: white;
            border: 3px solid #3498db;
            border-radius: 15px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #3498db;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .group-btn.completed {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            border-color: #2ecc71;
            color: white;
        }
        
        .rating-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
        }
        
        .dimension-slider {
            width: 100%;
            height: 8px;
            margin: 15px 0;
            -webkit-appearance: none;
            background: linear-gradient(to right, #e74c3c, #f39c12, #2ecc71);
            border-radius: 10px;
            outline: none;
        }
        
        .submit-btn {
            display: block;
            width: 100%;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 20px;
            font-size: 1.3rem;
            border-radius: 50px;
            font-weight: 700;
            margin-top: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
        }
        
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            display: none;
            animation: slideIn 0.4s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .scheme-list {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }
        
        .scheme-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
        }
        
        .scheme-card.active {
            border-left-color: #2ecc71;
            background: #f8fff9;
        }
        
        .scheme-editor {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .export-options {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .container, .mobile-container {
                padding: 15px;
            }
            
            .navbar {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-btn, .group-selection {
                width: 100%;
            }
            
            .group-selection {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .export-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="message success" id="successMessage">âœ… æ“ä½œæˆåŠŸï¼</div>
    <div class="message info" id="infoMessage">ğŸ“Š å¤„ç†ä¸­...</div>
    <div class="message warning" id="warningMessage">âš ï¸ æ“ä½œæç¤º</div>
    
    <!-- ç®¡ç†ç«¯é¡µé¢ -->
    <div id="adminPage" class="page active">
        <div class="container">
            <div class="navbar">
                <button class="nav-btn active" onclick="showAdminPage('home')">ğŸ  ç³»ç»Ÿé¦–é¡µ</button>
                <button class="nav-btn" onclick="showAdminPage('scheme')">ğŸ“‹ è¯„åˆ†æ–¹æ¡ˆ</button>
                <button class="nav-btn" onclick="showAdminPage('results')">ğŸ“Š æŸ¥çœ‹ç»“æœ</button>
                <button class="nav-btn" onclick="showAdminPage('history')">ğŸ“œ è¯„åˆ†å†å²</button>
            </div>
            
            <div id="adminHomePage" class="admin-content active">
                <h2 class="panel-title">ğŸ¯ é›…ä¸½æ´ç ”å‘ä¸­å¿ƒè¯„åˆ†ç³»ç»Ÿç®¡ç†åå°</h2>
                
                <div class="admin-content">
                    <h3>ï¿½ åˆ†æ•°ç»Ÿè®¡æ–¹æ¡ˆ</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div style="padding: 20px; border: 2px solid #e9ecef; border-radius: 10px; cursor: pointer; transition: all 0.3s;" 
                             id="method1Card" onclick="selectScoringMethod('method1')">
                            <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 10px;">æ–¹æ¡ˆ1 - å»æå€¼å¹³å‡æ³•</div>
                            <div style="color: #7f8c8d; font-size: 0.9rem;">å»æ‰æœ€é«˜åˆ†å’Œæœ€ä½åˆ†åå–å¹³å‡åˆ†</div>
                            <div style="margin-top: 10px; font-size: 0.85rem; color: #3498db;">å½“å‰ä½¿ç”¨ä¸­</div>
                        </div>
                        
                        <div style="padding: 20px; border: 2px solid #e9ecef; border-radius: 10px; cursor: pointer; transition: all 0.3s;" 
                             id="method2Card" onclick="selectScoringMethod('method2')">
                            <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 10px;">æ–¹æ¡ˆ2 - ç®€å•å¹³å‡æ³•</div>
                            <div style="color: #7f8c8d; font-size: 0.9rem;">æ‰€æœ‰è¯„å§”è¯„åˆ†ç›´æ¥å–å¹³å‡åˆ†</div>
                            <div style="margin-top: 10px; font-size: 0.85rem; color: #7f8c8d;">ç‚¹å‡»é€‰æ‹©</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn" onclick="applyScoringMethod()">âœ… åº”ç”¨ç»Ÿè®¡æ–¹æ¡ˆ</button>
                    </div>
                </div>
                
                <div class="admin-content">
                    <h3>ï¿½ é“¾æ¥ç®¡ç†</h3>
                    
                    <div style="margin-bottom: 25px;">
                        <h4>ğŸ“± è¯„åˆ†ç‰ˆé“¾æ¥ï¼ˆè¯„å§”ä¸“ç”¨ï¼‰</h4>
                        <div class="share-link" id="ratingLink">åŠ è½½ä¸­...</div>
                        <button class="btn" onclick="copyRatingLink()">ğŸ“‹ å¤åˆ¶è¯„åˆ†é“¾æ¥</button>
                    </div>
                    
                    <div>
                        <h4>ğŸ’» ç®¡ç†ç‰ˆé“¾æ¥ï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰</h4>
                        <div class="share-link" id="adminLink">åŠ è½½ä¸­...</div>
                        <button class="btn btn-secondary" onclick="copyAdminLink()">ğŸ“‹ å¤åˆ¶ç®¡ç†é“¾æ¥</button>
                    </div>
                </div>
                
                <div class="admin-content">
                    <h3>ğŸ“ˆ å®æ—¶ç»Ÿè®¡</h3>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="adminTotalRatings">0</div>
                            <div class="stat-label">æ€»è¯„åˆ†æ¬¡æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="adminAvgScore">0.0</div>
                            <div class="stat-label">å¹³å‡æ€»åˆ†</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="adminCompleted">0/4</div>
                            <div class="stat-label">å·²è¯„åˆ†ç»„æ•°</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button class="btn" onclick="syncData()">ğŸ”„ åŒæ­¥æ•°æ®</button>
                        <button class="btn btn-secondary" onclick="showAdminPage('results')">ğŸ“Š æŸ¥çœ‹è¯¦æƒ…</button>
                        <button class="btn btn-warning" onclick="resetAllData()">ğŸ”„ é‡ç½®æ•°æ®</button>
                    </div>
                </div>
                
                <div class="admin-content">
                    <h3>ğŸ”„ é‡è¯„è¯·æ±‚ç®¡ç†</h3>
                    <div id="reRatingRequestsList"></div>
                </div>
            </div>
            
            <div id="adminSchemePage" class="admin-content">
                <h2 class="panel-title">âš™ï¸ è¯„åˆ†æ–¹æ¡ˆç®¡ç†</h2>
                
                <div class="admin-content">
                    <h3>ğŸ“‹ è¯„åˆ†ç»„åç®¡ç†</h3>
                    
                    <div id="groupNamesList" style="display: grid; gap: 15px; margin: 20px 0;"></div>
                    
                    <div style="text-align: center; margin: 25px 0;">
                        <button class="btn" onclick="showAddGroupName()">â• æ·»åŠ ç»„å</button>
                    </div>
                </div>
                
                <div class="admin-content">
                    <h3>ğŸ“‹ è¯„åˆ†æ–¹æ¡ˆåˆ—è¡¨</h3>
                    
                    <div class="scheme-list" id="schemeList"></div>
                    
                    <div style="text-align: center; margin: 25px 0;">
                        <button class="btn" onclick="showSchemeEditorNew()">â• æ–°å»ºæ–¹æ¡ˆ</button>
                        <button class="btn btn-secondary" onclick="exportSchemes()">ğŸ“¥ å¯¼å‡ºæ–¹æ¡ˆ</button>
                        <button class="btn btn-warning" onclick="importSchemes()">ğŸ“¤ å¯¼å…¥æ–¹æ¡ˆ</button>
                        <button class="btn" onclick="exportSchemesToCloud()">â˜ï¸ å¯¼å‡ºæ–¹æ¡ˆåˆ°äº‘ç«¯</button>
                        <button class="btn" onclick="importSchemesFromCloud()">â˜ï¸ ä»äº‘ç«¯å¯¼å…¥</button>
                    </div>
                </div>
                
                <div class="scheme-editor" id="schemeEditor" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 id="editorTitle">æ–°å»ºè¯„åˆ†æ–¹æ¡ˆ</h3>
                        <div>
                            <button class="btn" onclick="saveScheme()">ğŸ’¾ ä¿å­˜æ–¹æ¡ˆ</button>
                            <button class="btn btn-secondary" onclick="cancelEdit()">âŒ å–æ¶ˆ</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label>æ–¹æ¡ˆåç§°</label>
                        <input type="text" class="form-input" id="schemeName" placeholder="è¯·è¾“å…¥æ–¹æ¡ˆåç§°">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label>æ–¹æ¡ˆæè¿°</label>
                        <textarea class="form-input" id="schemeDescription" placeholder="è¯·è¾“å…¥æ–¹æ¡ˆæè¿°" rows="3"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label>è¯„åˆ†ç»´åº¦</label>
                        <div id="dimensionEditor"></div>
                        <button class="btn" onclick="addDimension()" style="margin-top: 10px;">â• æ·»åŠ ç»´åº¦</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label>æ€»åˆ†è®¾ç½®</label>
                        <input type="number" class="form-input" id="totalScore" placeholder="æ€»åˆ†" value="100" min="1">
                    </div>
                </div>
                
                <div class="admin-content" id="currentSchemeInfo">
                    <h3>ğŸ“Š å½“å‰ä½¿ç”¨æ–¹æ¡ˆ</h3>
                    <div id="activeSchemeDisplay"></div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <h4>ğŸ”— æ–¹æ¡ˆé“¾æ¥</h4>
                        <div class="share-link" id="schemeLink1">åŠ è½½ä¸­...</div>
                        <button class="btn" onclick="copySchemeLink('scheme1')" style="margin-bottom: 15px;">ğŸ“‹ å¤åˆ¶æ–¹æ¡ˆ1é“¾æ¥</button>
                        
                        <div class="share-link" id="schemeLink2">åŠ è½½ä¸­...</div>
                        <button class="btn btn-secondary" onclick="copySchemeLink('scheme2')">ğŸ“‹ å¤åˆ¶æ–¹æ¡ˆ2é“¾æ¥</button>
                    </div>
                </div>
            </div>
            
            <div id="adminResultsPage" class="admin-content">
                <h2 class="panel-title">ğŸ† è¯„åˆ†ç»“æœ</h2>
                
                <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: #e8f4fd; border-radius: 10px;">
                    <strong>å½“å‰ç»Ÿè®¡æ–¹æ¡ˆï¼š</strong>
                    <span id="currentScoringMethodDisplay" style="color: #3498db; font-weight: 700;">æ–¹æ¡ˆ1 - å»æå€¼å¹³å‡æ³•</span>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="resultsTotalRatings">0</div>
                        <div class="stat-label">æ€»è¯„åˆ†æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="resultsAvgScore">0.0</div>
                        <div class="stat-label">å¹³å‡æ€»åˆ†</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="resultsCompleted">0/4</div>
                        <div class="stat-label">å·²è¯„åˆ†ç»„æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="resultsHighest">0.0</div>
                        <div class="stat-label">æœ€é«˜å¾—åˆ†</div>
                    </div>
                </div>
                
                <div class="admin-content">
                    <h3>ğŸ“ˆ æ’åæƒ…å†µ</h3>
                    <div id="rankingResults">
                        <p style="text-align: center; padding: 40px; color: #7f8c8d;">æš‚æ— è¯„åˆ†æ•°æ®</p>
                    </div>
                </div>
                
                <div class="admin-content">
                    <h3>ğŸ“¥ å¯¼å‡ºæ•°æ®</h3>
                    <div class="export-options">
                        <button class="btn" onclick="exportToExcel()">ğŸ“Š å¯¼å‡ºExcel</button>
                        <button class="btn btn-secondary" onclick="exportToWord()">ğŸ“„ å¯¼å‡ºWord</button>
                        <button class="btn btn-warning" onclick="exportToJSON()">ğŸ“‹ å¯¼å‡ºJSON</button>
                    </div>
                </div>
                
                <div class="admin-content">
                    <h3>ğŸ’¾ ä¿å­˜å½“å‰è¯„åˆ†</h3>
                    <p style="color: #7f8c8d; margin-bottom: 15px;">å°†å½“å‰è¯„åˆ†æ–¹æ¡ˆå’Œè¯„åˆ†ç»“æœä¿å­˜åˆ°å†å²è®°å½•ä¸­ï¼Œæ–¹ä¾¿åç»­æŸ¥çœ‹</p>
                    <button class="btn" onclick="saveCurrentRatingToHistory()" style="width: 100%;">ğŸ’¾ ä¿å­˜åˆ°å†å²è®°å½•</button>
                </div>
            </div>
            
            <div id="adminHistoryPage" class="admin-content">
                <h2 class="panel-title">ğŸ“œ è¯„åˆ†å†å²</h2>
                
                <div id="ratingHistoryList"></div>
            </div>
        </div>
    </div>
    
    <!-- æ‰‹æœºç«¯é¡µé¢ -->
    <div id="mobilePage" class="page">
        <div class="mobile-container">
            <div id="mobileGroupPage" class="page active">
                <div class="page-header">
                    <h1>å°Šé‡ï¼šæ‹…å½“ï¼šåˆ›æ–°ï¼šç®€å•ï¼šå…±èµ¢</h1>
                    <p>è¯·é€‰æ‹©è¦è¯„åˆ†çš„ç»„åˆ«</p>
                </div>
                
                <div class="mobile-content">
                    <div style="text-align: center; padding: 20px;">
                        <div class="stat-value" id="completedCount">0/0</div>
                        <div class="stat-label">å·²è¯„åˆ†è¿›åº¦</div>
                    </div>
                </div>
                
                <div class="mobile-content">
                    <h3 style="text-align: center;">ğŸ“ é€‰æ‹©è¯„åˆ†ç»„</h3>
                    <div class="group-selection" id="groupSelectionContainer"></div>
                </div>
                
                <div class="mobile-content">
                    <h3 style="text-align: center;">ğŸ”„ æˆ‘çš„é‡è¯„è¯·æ±‚</h3>
                    <div id="myReRatingRequests"></div>
                </div>
            </div>
            
            <div id="mobileRatingPage" class="page"></div>
            <div id="mobileReviewPage" class="page"></div>
        </div>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨
        let groupsData = {};
        
        // åˆå§‹åŒ–ç»„æ•°æ®
        function initializeGroupsData() {
            groupNames.forEach(groupName => {
                if (!groupsData[groupName]) {
                    groupsData[groupName] = { scores: [], finalScore: 0 };
                }
            });
        }
        
        let ratingSchemes = {};
        let currentSchemeId = "scheme1";
        let currentRatingGroup = '';
        let currentVersion = 'admin';
        let isSubmitting = false;
        let currentEditingScheme = null;
        let currentScoringMethod = "method1";
        let groupNames = ["æ´—æŠ¤ç»„", "æŠ¤è‚¤1ç»„", "æŠ¤è‚¤2ç»„", "æŠ¤è‚¤3ç»„"];
        let reRatingRequests = [];
        let ratingHistory = [];
        let autoSyncInterval = null;
        
        // JSONBin.io é…ç½®
        const JSONBIN_API_KEY = '$2a$10$c2NEBUyWOI3Yqv3mlGn8zeY7ysKbSPQdFv9Oyli9LN5J8LN1wkvSK'; // è¯·æ›¿æ¢ä¸ºä½ çš„ API Key
        const JSONBIN_BIN_ID = '696ee7fe43b1c97be93bf06b'; // è¯·æ›¿æ¢ä¸ºä½ çš„ Bin ID
        const JSONBIN_API_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;

        // åˆå§‹åŒ–
        async function init() {
            console.log('ç³»ç»Ÿåˆå§‹åŒ–...');
            initializeGroupsData();
            initializeDefaultScheme();
            detectVersion();
            await loadData();
            updateShareLinks();
            updateSchemeLinks();
            checkHash();
            updateAllResults();
            updateSchemeList();
            updateCurrentSchemeInfo();
            updateScoringMethodUI();
            updateGroupNamesList();
            updateReRatingRequestsList();
            updateRatingHistoryList();
            
            // å¦‚æœæ˜¯è¯„å§”ç«¯ï¼Œæ›´æ–°æˆ‘çš„é‡è¯„è¯·æ±‚åˆ—è¡¨
            if (currentVersion === 'mobile') {
                updateMyReRatingRequests();
            }
            
            // å¯åŠ¨è‡ªåŠ¨åŒæ­¥ï¼ˆæ¯30ç§’åŒæ­¥ä¸€æ¬¡ï¼‰
            startAutoSync();
            
            console.log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }
        
        // å¯åŠ¨è‡ªåŠ¨åŒæ­¥
        function startAutoSync() {
            // æ¸…é™¤å·²æœ‰çš„å®šæ—¶å™¨
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
            }
            
            // æ¯30ç§’è‡ªåŠ¨åŒæ­¥ä¸€æ¬¡æ•°æ®
            autoSyncInterval = setInterval(async () => {
                console.log('è‡ªåŠ¨åŒæ­¥æ•°æ®...');
                await loadData();
                
                if (currentVersion === 'admin') {
                    updateReRatingRequestsList();
                    updateAllResults();
                    updateGroupSelection();
                } else {
                    // è¯„å§”ç«¯ä¹Ÿè‡ªåŠ¨åŒæ­¥ï¼ŒæŸ¥çœ‹é‡è¯„è¯·æ±‚çŠ¶æ€
                    updateMyReRatingRequests();
                    updateGroupSelection();
                }
            }, 30000); // 30ç§’
        }
        
        // åœæ­¢è‡ªåŠ¨åŒæ­¥
        function stopAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
        }
        
        // åˆå§‹åŒ–é»˜è®¤æ–¹æ¡ˆ
        function initializeDefaultScheme() {
            // æ–¹æ¡ˆ1 - æ´—æŠ¤ç»„ä¸“ç”¨
            ratingSchemes['scheme1'] = {
                id: "scheme1",
                name: "æ–¹æ¡ˆ1 - æ´—æŠ¤ç»„ä¸“ç”¨",
                description: "é’ˆå¯¹æ´—æŠ¤ç»„ä¼˜åŒ–çš„è¯„åˆ†æ–¹æ¡ˆï¼Œä¾§é‡äº§å“å®ç”¨æ€§",
                dimensions: [
                    { 
                        name: "è¡¨è¾¾èƒ½åŠ›", 
                        weight: 15,
                        minScore: 1,
                        maxScore: 10,
                        scoreLevels: [
                            { score: 1, description: "è¡¨è¾¾ä¸æ¸…" },
                            { score: 4, description: "åŸºæœ¬æ¸…æ™°" },
                            { score: 7, description: "è¡¨è¾¾æµç•…" },
                            { score: 10, description: "è¡¨è¾¾å‡ºè‰²" }
                        ]
                    },
                    { 
                        name: "äº§å“ä½“éªŒæ„Ÿ", 
                        weight: 20,
                        minScore: 1,
                        maxScore: 10,
                        scoreLevels: [
                            { score: 1, description: "ä½“éªŒå·®" },
                            { score: 4, description: "ä½“éªŒä¸€èˆ¬" },
                            { score: 7, description: "ä½“éªŒè‰¯å¥½" },
                            { score: 10, description: "ä½“éªŒä¼˜ç§€" }
                        ]
                    },
                    { 
                        name: "äº§å“å®ç”¨æ€§", 
                        weight: 25,
                        minScore: 1,
                        maxScore: 10,
                        scoreLevels: [
                            { score: 1, description: "ä¸å®ç”¨" },
                            { score: 4, description: "åŸºæœ¬å®ç”¨" },
                            { score: 7, description: "æ¯”è¾ƒå®ç”¨" },
                            { score: 10, description: "éå¸¸å®ç”¨" }
                        ]
                    },
                    { 
                        name: "æŠ€æœ¯åˆ›æ–°æ€§", 
                        weight: 15,
                        minScore: 1,
                        maxScore: 10,
                        scoreLevels: [
                            { score: 1, description: "æ— åˆ›æ–°" },
                            { score: 4, description: "ç•¥æœ‰åˆ›æ–°" },
                            { score: 7, description: "åˆ›æ–°æ˜æ˜¾" },
                            { score: 10, description: "åˆ›æ–°çªå‡º" }
                        ]
                    },
                    { 
                        name: "äº§å“é˜è¿°å®Œæ•´åº¦", 
                        weight: 15,
                        minScore: 1,
                        maxScore: 10,
                        scoreLevels: [
                            { score: 1, description: "ä¸å®Œæ•´" },
                            { score: 4, description: "åŸºæœ¬å®Œæ•´" },
                            { score: 7, description: "æ¯”è¾ƒå®Œæ•´" },
                            { score: 10, description: "éå¸¸å®Œæ•´" }
                        ]
                    },
                    { 
                        name: "é—®ç­”æ»¡æ„åº¦", 
                        weight: 10,
                        minScore: 1,
                        maxScore: 10,
                        scoreLevels: [
                            { score: 1, description: "ä¸æ»¡æ„" },
                            { score: 4, description: "åŸºæœ¬æ»¡æ„" },
                            { score: 7, description: "æ¯”è¾ƒæ»¡æ„" },
                            { score: 10, description: "éå¸¸æ»¡æ„" }
                        ]
                    }
                ],
                totalScore: 100,
                isActive: true,
                createdAt: new Date().getTime(),
                schemeLink: generateSchemeLink('scheme1')
            };
            
            // æ–¹æ¡ˆ2 - æŠ¤è‚¤ç»„ä¸“ç”¨
            ratingSchemes['scheme2'] = {
                id: "scheme2",
                name: "æ–¹æ¡ˆ2 - æŠ¤è‚¤ç»„ä¸“ç”¨",
                description: "é’ˆå¯¹æŠ¤è‚¤ç»„ä¼˜åŒ–çš„è¯„åˆ†æ–¹æ¡ˆï¼Œä¾§é‡æŠ€æœ¯åˆ›æ–°å’Œæ•ˆæœ",
                dimensions: [
                    { 
                        name: "æŠ€æœ¯å«é‡", 
                        weight: 25,
                        minScore: 1,
                        maxScore: 15,
                        scoreLevels: [
                            { score: 1, description: "æŠ€æœ¯å«é‡ä½" },
                            { score: 5, description: "æŠ€æœ¯ä¸€èˆ¬" },
                            { score: 10, description: "æŠ€æœ¯è¾ƒé«˜" },
                            { score: 15, description: "æŠ€æœ¯å¾ˆé«˜" }
                        ]
                    },
                    { 
                        name: "ä½¿ç”¨æ•ˆæœ", 
                        weight: 25,
                        minScore: 1,
                        maxScore: 15,
                        scoreLevels: [
                            { score: 1, description: "æ•ˆæœå·®" },
                            { score: 5, description: "æ•ˆæœä¸€èˆ¬" },
                            { score: 10, description: "æ•ˆæœè‰¯å¥½" },
                            { score: 15, description: "æ•ˆæœä¼˜ç§€" }
                        ]
                    },
                    { 
                        name: "åˆ›æ–°æ€§", 
                        weight: 20,
                        minScore: 1,
                        maxScore: 10,
                        scoreLevels: [
                            { score: 1, description: "æ— åˆ›æ–°" },
                            { score: 4, description: "ç•¥æœ‰åˆ›æ–°" },
                            { score: 7, description: "åˆ›æ–°æ˜æ˜¾" },
                            { score: 10, description: "åˆ›æ–°çªå‡º" }
                        ]
                    },
                    { 
                        name: "å®‰å…¨æ€§", 
                        weight: 15,
                        minScore: 1,
                        maxScore: 10,
                        scoreLevels: [
                            { score: 1, description: "ä¸å®‰å…¨" },
                            { score: 4, description: "åŸºæœ¬å®‰å…¨" },
                            { score: 7, description: "æ¯”è¾ƒå®‰å…¨" },
                            { score: 10, description: "éå¸¸å®‰å…¨" }
                        ]
                    },
                    { 
                        name: "å¸‚åœºå‰æ™¯", 
                        weight: 15,
                        minScore: 1,
                        maxScore: 10,
                        scoreLevels: [
                            { score: 1, description: "å‰æ™¯å·®" },
                            { score: 4, description: "å‰æ™¯ä¸€èˆ¬" },
                            { score: 7, description: "å‰æ™¯è‰¯å¥½" },
                            { score: 10, description: "å‰æ™¯å¹¿é˜”" }
                        ]
                    }
                ],
                totalScore: 100,
                isActive: false,
                createdAt: new Date().getTime(),
                schemeLink: generateSchemeLink('scheme2')
            };
        }
        
        // ç”Ÿæˆæ–¹æ¡ˆé“¾æ¥
        function generateSchemeLink(schemeId) {
            const baseUrl = window.location.href.split('#')[0];
            return `${baseUrl}#mobile&scheme=${schemeId}`;
        }
        
        // æ›´æ–°æ–¹æ¡ˆé“¾æ¥æ˜¾ç¤º
        function updateSchemeLinks() {
            if (ratingSchemes['scheme1'] && document.getElementById('schemeLink1')) {
                document.getElementById('schemeLink1').textContent = ratingSchemes['scheme1'].schemeLink;
            }
            if (ratingSchemes['scheme2'] && document.getElementById('schemeLink2')) {
                document.getElementById('schemeLink2').textContent = ratingSchemes['scheme2'].schemeLink;
            }
        }
        
        // å¤åˆ¶æ–¹æ¡ˆé“¾æ¥
        function copySchemeLink(schemeId) {
            const scheme = ratingSchemes[schemeId];
            if (scheme && scheme.schemeLink) {
                copyToClipboard(scheme.schemeLink, `âœ… ${scheme.name}é“¾æ¥å·²å¤åˆ¶ï¼`);
            }
        }
        
        // æ£€æµ‹å½“å‰ç‰ˆæœ¬
        function detectVersion() {
            const hash = window.location.hash.replace('#', '');
            if (hash.includes('mobile')) {
                currentVersion = 'mobile';
                document.getElementById('adminPage').style.display = 'none';
                document.getElementById('mobilePage').style.display = 'block';
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šçš„æ–¹æ¡ˆ
                const schemeMatch = hash.match(/scheme=(\w+)/);
                if (schemeMatch && ratingSchemes[schemeMatch[1]]) {
                    currentSchemeId = schemeMatch[1];
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šçš„ç»Ÿè®¡æ–¹æ¡ˆ
                const scoringMatch = hash.match(/scoring=(\w+)/);
                if (scoringMatch && (scoringMatch[1] === 'method1' || scoringMatch[1] === 'method2')) {
                    currentScoringMethod = scoringMatch[1];
                }
            } else {
                currentVersion = 'admin';
                document.getElementById('adminPage').style.display = 'block';
                document.getElementById('mobilePage').style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºç®¡ç†ç«¯é¡µé¢
        function showAdminPage(pageName) {
            // éšè—æ‰€æœ‰ç®¡ç†ç«¯é¡µé¢
            document.querySelectorAll('#adminPage .admin-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            document.getElementById('admin' + pageName.charAt(0).toUpperCase() + pageName.slice(1) + 'Page').classList.add('active');
            
            // æ›´æ–°å¯¼èˆªæŒ‰é’®
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ ¹æ®é¡µé¢åç§°æ¿€æ´»å¯¹åº”æŒ‰é’®
            const targetBtn = Array.from(document.querySelectorAll('.nav-btn')).find(btn => 
                btn.textContent.includes(
                    pageName === 'home' ? 'ğŸ ' : 
                    pageName === 'scheme' ? 'ğŸ“‹' : 
                    pageName === 'results' ? 'ğŸ“Š' : 'ğŸ“œ'
                )
            );
            
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // å¦‚æœæ˜¯ç»“æœé¡µé¢ï¼Œåˆ·æ–°æ•°æ®
            if (pageName === 'results') {
                updateAllResults();
            }
            
            // å¦‚æœæ˜¯æ–¹æ¡ˆé¡µé¢ï¼Œåˆ·æ–°æ–¹æ¡ˆåˆ—è¡¨
            if (pageName === 'scheme') {
                updateSchemeList();
            }
            
            // å¦‚æœæ˜¯å†å²é¡µé¢ï¼Œåˆ·æ–°å†å²åˆ—è¡¨
            if (pageName === 'history') {
                updateRatingHistoryList();
            }
        }
        
        // æ›´æ–°ç»„ååˆ—è¡¨
        function updateGroupNamesList() {
            const groupNamesList = document.getElementById('groupNamesList');
            if (!groupNamesList) return;
            
            groupNamesList.innerHTML = '';
            
            groupNames.forEach((groupName, index) => {
                const groupCard = document.createElement('div');
                groupCard.style.background = 'white';
                groupCard.style.borderRadius = '15px';
                groupCard.style.padding = '20px';
                groupCard.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.1)';
                groupCard.style.borderLeft = '4px solid #3498db';
                
                groupCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-weight: 700; font-size: 1.2rem; color: #2c3e50;">${groupName}</div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="editGroupName(${index})">âœï¸ ç¼–è¾‘</button>
                            <button class="btn btn-danger" onclick="deleteGroupName(${index})" ${groupNames.length <= 1 ? 'disabled' : ''}>ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                `;
                
                groupNamesList.appendChild(groupCard);
            });
        }
        
        // æ˜¾ç¤ºæ·»åŠ ç»„å
        function showAddGroupName() {
            const newGroupName = prompt('è¯·è¾“å…¥æ–°çš„ç»„åï¼š');
            if (newGroupName && newGroupName.trim()) {
                addGroupName(newGroupName.trim());
            }
        }
        
        // æ·»åŠ ç»„å
        function addGroupName(name) {
            if (groupNames.includes(name)) {
                showMessage('âš ï¸ è¯¥ç»„åå·²å­˜åœ¨ï¼', 'warning');
                return;
            }
            
            groupNames.push(name);
            groupsData[name] = { scores: [], finalScore: 0 };
            
            saveData();
            updateGroupNamesList();
            updateGroupSelection();
            updateAllResults();
            showMessage('âœ… ç»„åæ·»åŠ æˆåŠŸï¼');
        }
        
        // ç¼–è¾‘ç»„å
        function editGroupName(index) {
            const oldName = groupNames[index];
            const newName = prompt('è¯·è¾“å…¥æ–°çš„ç»„åï¼š', oldName);
            
            if (newName && newName.trim() && newName !== oldName) {
                if (groupNames.includes(newName)) {
                    showMessage('âš ï¸ è¯¥ç»„åå·²å­˜åœ¨ï¼', 'warning');
                    return;
                }
                
                // ä¿ç•™åŸæœ‰çš„è¯„åˆ†æ•°æ®
                const oldData = groupsData[oldName];
                
                // æ›´æ–°ç»„å
                groupNames[index] = newName;
                
                // è¿ç§»æ•°æ®åˆ°æ–°ç»„å
                groupsData[newName] = oldData || { scores: [], finalScore: 0 };
                delete groupsData[oldName];
                
                saveData();
                updateGroupNamesList();
                updateGroupSelection();
                updateAllResults();
                showMessage('âœ… ç»„åä¿®æ”¹æˆåŠŸï¼');
            }
        }
        
        // åˆ é™¤ç»„å
        function deleteGroupName(index) {
            const groupName = groupNames[index];
            
            if (groupNames.length <= 1) {
                showMessage('âš ï¸ è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªç»„åï¼', 'warning');
                return;
            }
            
            const hasScores = groupsData[groupName] && groupsData[groupName].scores.length > 0;
            
            if (hasScores) {
                if (!confirm(`âš ï¸ ç»„"${groupName}"å·²æœ‰è¯„åˆ†æ•°æ®ï¼Œç¡®å®šè¦åˆ é™¤å—ï¼Ÿæ­¤æ“ä½œå°†æ¸…é™¤è¯¥ç»„çš„æ‰€æœ‰è¯„åˆ†è®°å½•ï¼`)) {
                    return;
                }
            } else {
                if (!confirm(`ç¡®å®šè¦åˆ é™¤ç»„"${groupName}"å—ï¼Ÿ`)) {
                    return;
                }
            }
            
            // åˆ é™¤ç»„å
            groupNames.splice(index, 1);
            
            // åˆ é™¤ç»„æ•°æ®
            delete groupsData[groupName];
            
            saveData();
            updateGroupNamesList();
            updateGroupSelection();
            updateAllResults();
            showMessage('âœ… ç»„ååˆ é™¤æˆåŠŸï¼');
        }
        
        // æ›´æ–°é‡è¯„è¯·æ±‚åˆ—è¡¨
        function updateReRatingRequestsList() {
            const reRatingRequestsList = document.getElementById('reRatingRequestsList');
            if (!reRatingRequestsList) return;
            
            const pendingRequests = reRatingRequests.filter(req => req.status === 'pending');
            
            if (pendingRequests.length === 0) {
                reRatingRequestsList.innerHTML = '<p style="text-align: center; padding: 20px; color: #7f8c8d;">æš‚æ— å¾…å¤„ç†çš„é‡è¯„è¯·æ±‚</p>';
                return;
            }
            
            let html = '';
            pendingRequests.forEach(request => {
                html += `
                    <div style="background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 700; color: #2c3e50;">${request.userName}</div>
                                <div style="color: #7f8c8d; font-size: 0.9rem;">ç”³è¯·é‡è¯„: ${request.groupName}</div>
                            </div>
                            <div style="color: #7f8c8d; font-size: 0.85rem;">
                                ${new Date(request.requestTime).toLocaleString()}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn" onclick="approveReRating('${request.id}')" style="flex: 1; padding: 8px 15px; font-size: 0.9rem;">âœ… æ‰¹å‡†</button>
                            <button class="btn btn-danger" onclick="rejectReRating('${request.id}')" style="flex: 1; padding: 8px 15px; font-size: 0.9rem;">âŒ æ‹’ç»</button>
                        </div>
                    </div>
                `;
            });
            
            reRatingRequestsList.innerHTML = html;
        }
        
        // æ‰¹å‡†é‡è¯„è¯·æ±‚
        async function approveReRating(requestId) {
            const request = reRatingRequests.find(req => req.id === requestId);
            if (!request) return;
            
            if (!confirm(`ç¡®å®šæ‰¹å‡† ${request.userName} å¯¹ ${request.groupName} çš„é‡è¯„è¯·æ±‚å—ï¼Ÿ`)) {
                return;
            }
            
            // æ¸…é™¤è¯¥è¯„å§”å¯¹è¯¥ç»„çš„è¯„åˆ†
            const group = groupsData[request.groupName];
            if (group) {
                group.scores = group.scores.filter(score => score.userId !== request.userId);
                group.finalScore = 0;
            }
            
            // æ›´æ–°è¯·æ±‚çŠ¶æ€
            request.status = 'approved';
            request.approvedTime = new Date().getTime();
            
            await saveData();
            updateReRatingRequestsList();
            updateAllResults();
            showMessage('âœ… å·²æ‰¹å‡†é‡è¯„è¯·æ±‚');
        }
        
        // æ‹’ç»é‡è¯„è¯·æ±‚
        async function rejectReRating(requestId) {
            const request = reRatingRequests.find(req => req.id === requestId);
            if (!request) return;
            
            if (!confirm(`ç¡®å®šæ‹’ç» ${request.userName} å¯¹ ${request.groupName} çš„é‡è¯„è¯·æ±‚å—ï¼Ÿ`)) {
                return;
            }
            
            // æ›´æ–°è¯·æ±‚çŠ¶æ€
            request.status = 'rejected';
            request.rejectedTime = new Date().getTime();
            
            await saveData();
            updateReRatingRequestsList();
            showMessage('âœ… å·²æ‹’ç»é‡è¯„è¯·æ±‚');
        }
        
        // æ›´æ–°æ–¹æ¡ˆåˆ—è¡¨
        function updateSchemeList() {
            const schemeList = document.getElementById('schemeList');
            if (!schemeList) return;
            
            schemeList.innerHTML = '';
            
            Object.keys(ratingSchemes).forEach(schemeId => {
                const scheme = ratingSchemes[schemeId];
                const isActive = schemeId === currentSchemeId;
                
                const schemeCard = document.createElement('div');
                schemeCard.className = `scheme-card ${isActive ? 'active' : ''}`;
                schemeCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="font-weight: 700; font-size: 1.2rem; color: #2c3e50;">${scheme.name} ${isActive ? 'âœ…' : ''}</div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="useScheme('${schemeId}')" ${isActive ? 'disabled' : ''}>${isActive ? 'ä½¿ç”¨ä¸­' : 'ä½¿ç”¨'}</button>
                            <button class="btn btn-secondary" onclick="editScheme('${schemeId}')">ç¼–è¾‘</button>
                        </div>
                    </div>
                    <div style="color: #7f8c8d; margin-bottom: 10px;">${scheme.description}</div>
                    <div style="margin-top: 15px;">
                        ${scheme.dimensions.map(dim => `
                            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f8f9fa;">
                                <span style="font-weight: 600;">${dim.name}</span>
                                <span style="color: #3498db; font-weight: 600;">${dim.weight}%</span>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9rem; color: #7f8c8d;">
                        åˆ›å»ºæ—¶é—´: ${new Date(scheme.createdAt).toLocaleString()}
                    </div>
                `;
                
                schemeList.appendChild(schemeCard);
            });
        }
        
        // ä½¿ç”¨æ–¹æ¡ˆ
        async function useScheme(schemeId) {
            currentSchemeId = schemeId;
            // æ›´æ–°æ–¹æ¡ˆé“¾æ¥
            ratingSchemes[schemeId].schemeLink = generateSchemeLink(schemeId);
            await saveData();
            updateSchemeList();
            updateCurrentSchemeInfo();
            updateSchemeLinks();
            showMessage('âœ… å·²åˆ‡æ¢åˆ°æ–¹æ¡ˆ: ' + ratingSchemes[schemeId].name);
        }
        
        // ç¼–è¾‘æ–¹æ¡ˆ
        function editScheme(schemeId) {
            currentEditingScheme = JSON.parse(JSON.stringify(ratingSchemes[schemeId]));
            showSchemeEditor();
        }
        
        // æ–°å»ºæ–¹æ¡ˆ
        function showSchemeEditorNew() {
            currentEditingScheme = {
                id: 'scheme_' + Date.now(),
                name: 'æ–°è¯„åˆ†æ–¹æ¡ˆ',
                description: '',
                dimensions: [
                    {
                        name: "æ–°ç»´åº¦",
                        weight: 100,
                        minScore: 1,
                        maxScore: 10,
                        scoreLevels: [
                            { score: 1, description: "å·®" },
                            { score: 5, description: "ä¸­" },
                            { score: 10, description: "ä¼˜" }
                        ]
                    }
                ],
                totalScore: 100,
                isActive: false,
                createdAt: new Date().getTime(),
                schemeLink: ''
            };
            showSchemeEditor();
        }
        
        // æ˜¾ç¤ºæ–¹æ¡ˆç¼–è¾‘å™¨
        function showSchemeEditor() {
            document.getElementById('schemeEditor').style.display = 'block';
            document.getElementById('schemeList').style.display = 'none';
            
            const editorTitle = document.getElementById('editorTitle');
            const schemeName = document.getElementById('schemeName');
            const schemeDescription = document.getElementById('schemeDescription');
            const totalScore = document.getElementById('totalScore');
            
            editorTitle.textContent = currentEditingScheme.id.includes('scheme_') ? 'æ–°å»ºè¯„åˆ†æ–¹æ¡ˆ' : 'ç¼–è¾‘è¯„åˆ†æ–¹æ¡ˆ: ' + currentEditingScheme.name;
            schemeName.value = currentEditingScheme.name;
            schemeDescription.value = currentEditingScheme.description;
            totalScore.value = currentEditingScheme.totalScore;
            
            // æ›´æ–°ç»´åº¦ç¼–è¾‘å™¨
            updateDimensionEditor();
        }
        
        // æ›´æ–°ç»´åº¦ç¼–è¾‘å™¨
        function updateDimensionEditor() {
            const dimensionEditor = document.getElementById('dimensionEditor');
            dimensionEditor.innerHTML = '';
            
            currentEditingScheme.dimensions.forEach((dimension, index) => {
                const dimensionElement = document.createElement('div');
                dimensionElement.style.background = '#f8f9fa';
                dimensionElement.style.borderRadius = '10px';
                dimensionElement.style.padding = '20px';
                dimensionElement.style.margin = '15px 0';
                
                dimensionElement.innerHTML = `
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; align-items: center; margin-bottom: 15px;">
                        <input type="text" class="form-input" value="${dimension.name}" placeholder="ç»´åº¦åç§°" onchange="updateDimension(${index}, 'name', this.value)">
                        <input type="number" class="form-input" value="${dimension.weight}" placeholder="æƒé‡" min="1" max="100" onchange="updateDimension(${index}, 'weight', this.value)">
                        <input type="number" class="form-input" value="${dimension.minScore}" placeholder="æœ€ä½åˆ†" onchange="updateDimension(${index}, 'minScore', this.value)">
                        <input type="number" class="form-input" value="${dimension.maxScore}" placeholder="æœ€é«˜åˆ†" onchange="updateDimension(${index}, 'maxScore', this.value)">
                        <button style="background: #e74c3c; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; font-size: 0.8rem;" 
                                onclick="removeDimension(${index})" ${currentEditingScheme.dimensions.length <= 1 ? 'disabled' : ''}>åˆ é™¤</button>
                    </div>
                    <div style="margin-top: 15px;">
                        <h4>åˆ†æ•°ç­‰çº§è¯´æ˜</h4>
                        ${dimension.scoreLevels.map((level, levelIndex) => `
                            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 10px;">
                                <input type="number" class="form-input" value="${level.score}" placeholder="åˆ†æ•°" onchange="updateScoreLevel(${index}, ${levelIndex}, 'score', this.value)">
                                <input type="text" class="form-input" value="${level.description}" placeholder="è¯´æ˜" onchange="updateScoreLevel(${index}, ${levelIndex}, 'description', this.value)">
                                <button style="background: #e74c3c; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; font-size: 0.8rem;" 
                                        onclick="removeScoreLevel(${index}, ${levelIndex})" ${dimension.scoreLevels.length <= 1 ? 'disabled' : ''}>åˆ é™¤</button>
                            </div>
                        `).join('')}
                        <button style="background: #2ecc71; color: white; border: none; border-radius: 5px; padding: 8px 15px; cursor: pointer; margin-top: 10px;" 
                                onclick="addScoreLevel(${index})">â• æ·»åŠ åˆ†æ•°ç­‰çº§</button>
                    </div>
                `;
                dimensionEditor.appendChild(dimensionElement);
            });
        }
        
        // æ›´æ–°ç»´åº¦
        function updateDimension(index, field, value) {
            if (field === 'weight') {
                value = parseInt(value);
            } else if (field === 'minScore' || field === 'maxScore') {
                value = parseFloat(value);
            }
            currentEditingScheme.dimensions[index][field] = value;
        }
        
        // æ›´æ–°åˆ†æ•°ç­‰çº§
        function updateScoreLevel(dimensionIndex, levelIndex, field, value) {
            if (field === 'score') {
                value = parseFloat(value);
            }
            currentEditingScheme.dimensions[dimensionIndex].scoreLevels[levelIndex][field] = value;
        }
        
        // æ·»åŠ ç»´åº¦
        function addDimension() {
            currentEditingScheme.dimensions.push({
                name: "æ–°ç»´åº¦",
                weight: 10,
                minScore: 1,
                maxScore: 10,
                scoreLevels: [
                    { score: 1, description: "å·®" },
                    { score: 5, description: "ä¸­" },
                    { score: 10, description: "ä¼˜" }
                ]
            });
            updateDimensionEditor();
        }
        
        // åˆ é™¤ç»´åº¦
        function removeDimension(index) {
            if (currentEditingScheme.dimensions.length > 1) {
                currentEditingScheme.dimensions.splice(index, 1);
                updateDimensionEditor();
            }
        }
        
        // æ·»åŠ åˆ†æ•°ç­‰çº§
        function addScoreLevel(dimensionIndex) {
            currentEditingScheme.dimensions[dimensionIndex].scoreLevels.push({
                score: 5,
                description: "ä¸­ç­‰"
            });
            updateDimensionEditor();
        }
        
        // åˆ é™¤åˆ†æ•°ç­‰çº§
        function removeScoreLevel(dimensionIndex, levelIndex) {
            if (currentEditingScheme.dimensions[dimensionIndex].scoreLevels.length > 1) {
                currentEditingScheme.dimensions[dimensionIndex].scoreLevels.splice(levelIndex, 1);
                updateDimensionEditor();
            }
        }
        
        // ä¿å­˜æ–¹æ¡ˆ
async function saveScheme() {
    const schemeName = document.getElementById('schemeName').value;
    const schemeDescription = document.getElementById('schemeDescription').value;
    const totalScore = parseInt(document.getElementById('totalScore').value);
    
    if (!schemeName.trim()) {
        showMessage('âš ï¸ è¯·è¾“å…¥æ–¹æ¡ˆåç§°', 'warning');
        return;
    }
    
    currentEditingScheme.name = schemeName;
    currentEditingScheme.description = schemeDescription;
    currentEditingScheme.totalScore = totalScore;
    
    ratingSchemes[currentEditingScheme.id] = currentEditingScheme;
    
    // æ›´æ–°æ–¹æ¡ˆé“¾æ¥
    ratingSchemes[currentEditingScheme.id].schemeLink = generateSchemeLink(currentEditingScheme.id);
    
    await saveData();
    cancelEdit();
    updateSchemeList();
    updateSchemeLinks();
    showMessage('âœ… æ–¹æ¡ˆä¿å­˜æˆåŠŸï¼');
}
        
        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            document.getElementById('schemeEditor').style.display = 'none';
            document.getElementById('schemeList').style.display = 'block';
            currentEditingScheme = null;
        }
        
        // å¯¼å‡ºæ–¹æ¡ˆ
        function exportSchemes() {
            const dataStr = JSON.stringify(ratingSchemes, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `è¯„åˆ†æ–¹æ¡ˆ_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
            link.click();
            showMessage('âœ… è¯„åˆ†æ–¹æ¡ˆå¯¼å‡ºæˆåŠŸï¼');
        }
        
        // å¯¼å‡ºæ–¹æ¡ˆåˆ°äº‘ç«¯
        async function exportSchemesToCloud() {
            showMessage('ğŸ“Š æ­£åœ¨å¯¼å‡ºæ–¹æ¡ˆåˆ°äº‘ç«¯...', 'info');
            
            try {
                // å…ˆè·å–å½“å‰äº‘ç«¯æ•°æ®
                const response = await axios.get(JSONBIN_API_URL, {
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY
                    }
                });
                
                const cloudData = response.data.record;
                
                // æ›´æ–°äº‘ç«¯æ•°æ®ä¸­çš„è¯„åˆ†æ–¹æ¡ˆ
                cloudData.ratingSchemes = ratingSchemes;
                
                // ä¿å­˜å›äº‘ç«¯
                await axios.put(JSONBIN_API_URL, cloudData, {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    }
                });
                
                showMessage('âœ… è¯„åˆ†æ–¹æ¡ˆå·²æˆåŠŸå¯¼å‡ºåˆ°äº‘ç«¯ï¼');
            } catch (error) {
                console.error('å¯¼å‡ºæ–¹æ¡ˆåˆ°äº‘ç«¯å¤±è´¥:', error);
                showMessage('âš ï¸ å¯¼å‡ºæ–¹æ¡ˆåˆ°äº‘ç«¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'warning');
            }
        }
        
        // å¯¼å…¥æ–¹æ¡ˆ
        async function importSchemes() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const importedSchemes = JSON.parse(e.target.result);
                        if (typeof importedSchemes === 'object') {
                            Object.keys(importedSchemes).forEach(schemeId => {
                                ratingSchemes[schemeId] = importedSchemes[schemeId];
                                // æ›´æ–°æ–¹æ¡ˆé“¾æ¥
                                ratingSchemes[schemeId].schemeLink = generateSchemeLink(schemeId);
                            });
                            await saveData();
                            updateSchemeList();
                            updateSchemeLinks();
                            showMessage('âœ… è¯„åˆ†æ–¹æ¡ˆå¯¼å…¥æˆåŠŸï¼');
                        } else {
                            showMessage('âš ï¸ æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'warning');
                        }
                    } catch (error) {
                        showMessage('âš ï¸ æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'warning');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // ä»äº‘ç«¯å¯¼å…¥æ–¹æ¡ˆ
        async function importSchemesFromCloud() {
            showMessage('ğŸ“Š æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ–¹æ¡ˆ...', 'info');
            
            try {
                const response = await axios.get(JSONBIN_API_URL, {
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY
                    }
                });
                
                const cloudData = response.data.record;
                
                if (cloudData && cloudData.ratingSchemes) {
                    showCloudSchemeSelector(cloudData.ratingSchemes);
                } else {
                    showMessage('âš ï¸ äº‘ç«¯æ•°æ®ä¸­æ²¡æœ‰æ‰¾åˆ°æ–¹æ¡ˆ', 'warning');
                }
            } catch (error) {
                console.error('ä»äº‘ç«¯å¯¼å…¥å¤±è´¥:', error);
                showMessage('âš ï¸ ä»äº‘ç«¯å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'warning');
            }
        }
        
        // æ˜¾ç¤ºäº‘ç«¯æ–¹æ¡ˆé€‰æ‹©å™¨
        function showCloudSchemeSelector(cloudSchemes) {
            const schemeList = document.getElementById('schemeList');
            const schemeEditor = document.getElementById('schemeEditor');
            
            if (!schemeList || !schemeEditor) return;
            
            let html = '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">';
            html += '<h3 style="color: #2c3e50; margin-bottom: 15px;">â˜ï¸ äº‘ç«¯æ–¹æ¡ˆåˆ—è¡¨</h3>';
            
            const schemeIds = Object.keys(cloudSchemes);
            
            if (schemeIds.length === 0) {
                html += '<p style="color: #7f8c8d;">äº‘ç«¯æš‚æ— æ–¹æ¡ˆ</p>';
            } else {
                schemeIds.forEach(schemeId => {
                    const scheme = cloudSchemes[schemeId];
                    const localScheme = ratingSchemes[schemeId];
                    const isLocal = !!localScheme;
                    const isUpdated = localScheme && scheme.createdAt > localScheme.createdAt;
                    
                    html += `
                        <div style="background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-weight: 700; color: #2c3e50;">${scheme.name}</div>
                                <div style="font-size: 0.8rem; color: ${isUpdated ? '#e74c3c' : '#7f8c8d'};">
                                    ${isUpdated ? 'ğŸ†• æœ‰æ›´æ–°' : (isLocal ? 'âœ“ å·²åŒæ­¥' : 'ğŸ“¥ æ–°æ–¹æ¡ˆ')}
                                </div>
                            </div>
                            <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 10px;">${scheme.description}</div>
                            <div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 15px;">
                                åˆ›å»ºæ—¶é—´: ${new Date(scheme.createdAt).toLocaleString()}
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn" onclick="importSingleScheme('${schemeId}')" style="padding: 8px 15px; font-size: 0.9rem;">ğŸ“¥ å¯¼å…¥</button>
                                <button class="btn btn-secondary" onclick="editCloudScheme('${schemeId}')" style="padding: 8px 15px; font-size: 0.9rem;">âœï¸ ç¼–è¾‘åå¯¼å…¥</button>
                                ${isLocal ? `<button class="btn btn-warning" onclick="replaceLocalScheme('${schemeId}')" style="padding: 8px 15px; font-size: 0.9rem;">ğŸ”„ æ›¿æ¢æœ¬åœ°</button>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '<button class="btn" onclick="cancelCloudImport()" style="width: 100%; margin-top: 15px;">âŒ å–æ¶ˆ</button>';
            html += '</div>';
            
            schemeList.innerHTML = html;
            schemeEditor.style.display = 'none';
        }
        
        // å¯¼å…¥å•ä¸ªæ–¹æ¡ˆ
        async function importSingleScheme(schemeId) {
            try {
                const response = await axios.get(JSONBIN_API_URL, {
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY
                    }
                });
                
                const cloudData = response.data.record;
                const scheme = cloudData.ratingSchemes[schemeId];
                
                if (scheme) {
                    ratingSchemes[schemeId] = scheme;
                    ratingSchemes[schemeId].schemeLink = generateSchemeLink(schemeId);
                    
                    await saveData();
                    updateSchemeList();
                    updateSchemeLinks();
                    showMessage('âœ… æ–¹æ¡ˆå¯¼å…¥æˆåŠŸï¼');
                }
            } catch (error) {
                console.error('å¯¼å…¥æ–¹æ¡ˆå¤±è´¥:', error);
                showMessage('âš ï¸ å¯¼å…¥æ–¹æ¡ˆå¤±è´¥', 'warning');
            }
        }
        
        // ç¼–è¾‘äº‘ç«¯æ–¹æ¡ˆ
        async function editCloudScheme(schemeId) {
            try {
                const response = await axios.get(JSONBIN_API_URL, {
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY
                    }
                });
                
                const cloudData = response.data.record;
                const scheme = cloudData.ratingSchemes[schemeId];
                
                if (scheme) {
                    currentEditingScheme = JSON.parse(JSON.stringify(scheme));
                    currentEditingScheme.id = 'scheme_' + Date.now();
                    showSchemeEditor();
                    showMessage('âœ… å·²åŠ è½½äº‘ç«¯æ–¹æ¡ˆï¼Œç¼–è¾‘åç‚¹å‡»ä¿å­˜å³å¯å¯¼å…¥');
                }
            } catch (error) {
                console.error('åŠ è½½äº‘ç«¯æ–¹æ¡ˆå¤±è´¥:', error);
                showMessage('âš ï¸ åŠ è½½äº‘ç«¯æ–¹æ¡ˆå¤±è´¥', 'warning');
            }
        }
        
        // æ›¿æ¢æœ¬åœ°æ–¹æ¡ˆ
        async function replaceLocalScheme(schemeId) {
            if (!confirm('ç¡®å®šè¦æ›¿æ¢æœ¬åœ°æ–¹æ¡ˆå—ï¼Ÿæœ¬åœ°æ–¹æ¡ˆå°†è¢«è¦†ç›–ï¼')) {
                return;
            }
            
            try {
                const response = await axios.get(JSONBIN_API_URL, {
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY
                    }
                });
                
                const cloudData = response.data.record;
                const scheme = cloudData.ratingSchemes[schemeId];
                
                if (scheme) {
                    ratingSchemes[schemeId] = scheme;
                    ratingSchemes[schemeId].schemeLink = generateSchemeLink(schemeId);
                    
                    await saveData();
                    updateSchemeList();
                    updateSchemeLinks();
                    showMessage('âœ… æœ¬åœ°æ–¹æ¡ˆå·²æ›¿æ¢ï¼');
                }
            } catch (error) {
                console.error('æ›¿æ¢æ–¹æ¡ˆå¤±è´¥:', error);
                showMessage('âš ï¸ æ›¿æ¢æ–¹æ¡ˆå¤±è´¥', 'warning');
            }
        }
        
        // å–æ¶ˆäº‘ç«¯å¯¼å…¥
        function cancelCloudImport() {
            updateSchemeList();
            document.getElementById('schemeEditor').style.display = 'none';
        }
        
        // ä¿å­˜å½“å‰è¯„åˆ†åˆ°å†å²
        async function saveCurrentRatingToHistory() {
            const historyName = prompt('è¯·è¾“å…¥å†å²è®°å½•åç§°ï¼š', `è¯„åˆ†è®°å½•_${new Date().toLocaleDateString().replace(/\//g, '-')}`);
            
            if (!historyName || !historyName.trim()) {
                showMessage('âš ï¸ è¯·è¾“å…¥å†å²è®°å½•åç§°', 'warning');
                return;
            }
            
            const historyRecord = {
                id: 'history_' + Date.now(),
                name: historyName.trim(),
                saveTime: new Date().getTime(),
                schemeId: currentSchemeId,
                scheme: JSON.parse(JSON.stringify(ratingSchemes[currentSchemeId])),
                scoringMethod: currentScoringMethod,
                groupNames: [...groupNames],
                groupsData: JSON.parse(JSON.stringify(groupsData)),
                summary: {
                    totalRatings: 0,
                    totalGroups: groupNames.length,
                    ratedGroups: 0,
                    ranking: []
                }
            };
            
            // è®¡ç®—æ‘˜è¦ä¿¡æ¯
            Object.keys(historyRecord.groupsData).forEach(groupName => {
                const group = historyRecord.groupsData[groupName];
                historyRecord.summary.totalRatings += group.scores.length;
                
                if (group.scores.length > 0) {
                    historyRecord.summary.ratedGroups++;
                }
                
                historyRecord.summary.ranking.push({
                    group: groupName,
                    finalScore: group.finalScore,
                    ratingCount: group.scores.length
                });
            });
            
            historyRecord.summary.ranking.sort((a, b) => b.finalScore - a.finalScore);
            
            ratingHistory.push(historyRecord);
            await saveData();
            updateRatingHistoryList();
            showMessage('âœ… è¯„åˆ†å†å²å·²ä¿å­˜ï¼');
        }
        
        // æ›´æ–°è¯„åˆ†å†å²åˆ—è¡¨
        function updateRatingHistoryList() {
            const ratingHistoryList = document.getElementById('ratingHistoryList');
            if (!ratingHistoryList) return;
            
            if (ratingHistory.length === 0) {
                ratingHistoryList.innerHTML = '<p style="text-align: center; padding: 40px; color: #7f8c8d;">æš‚æ— è¯„åˆ†å†å²è®°å½•</p>';
                return;
            }
            
            let html = '';
            ratingHistory.forEach((history, index) => {
                const rankedGroups = history.summary.ranking.slice(0, 3);
                
                html += `
                    <div style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <div style="font-weight: 700; font-size: 1.2rem; color: #2c3e50;">${history.name}</div>
                                <div style="color: #7f8c8d; font-size: 0.9rem;">${new Date(history.saveTime).toLocaleString()}</div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" onclick="viewHistory(${index})" style="padding: 8px 15px; font-size: 0.9rem;">ğŸ‘ï¸ æŸ¥çœ‹</button>
                                <button class="btn btn-danger" onclick="deleteHistory(${index})" style="padding: 8px 15px; font-size: 0.9rem;">ğŸ—‘ï¸ åˆ é™¤</button>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 10px;">ğŸ“Š è¯„åˆ†æ–¹æ¡ˆ: ${history.scheme.name}</div>
                            <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 5px;">
                                ç»Ÿè®¡æ–¹æ³•: ${history.scoringMethod === 'method1' ? 'å»æå€¼å¹³å‡æ³•' : 'ç®€å•å¹³å‡æ³•'}
                            </div>
                            <div style="color: #7f8c8d; font-size: 0.9rem;">
                                è¯„åˆ†ç»„æ•°: ${history.summary.ratedGroups}/${history.summary.totalGroups} | æ€»è¯„åˆ†æ¬¡æ•°: ${history.summary.totalRatings}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 10px;">ğŸ† å‰ä¸‰å</div>
                            ${rankedGroups.map((item, idx) => `
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                    <span style="color: ${idx === 0 ? '#f39c12' : idx === 1 ? '#95a5a6' : '#cd7f32'};">
                                        ${idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'} ${item.group}
                                    </span>
                                    <span style="font-weight: 600; color: #3498db;">${item.finalScore.toFixed(1)}åˆ†</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            ratingHistoryList.innerHTML = html;
        }
        
        // æŸ¥çœ‹å†å²è¯¦æƒ…
        function viewHistory(index) {
            const history = ratingHistory[index];
            if (!history) return;
            
            let detailsHtml = `
                <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">
                        <div>
                            <h3 style="color: #2c3e50; margin-bottom: 5px;">${history.name}</h3>
                            <div style="color: #7f8c8d; font-size: 0.9rem;">${new Date(history.saveTime).toLocaleString()}</div>
                        </div>
                        <button class="btn" onclick="closeHistoryDetail()" style="padding: 8px 15px;">âŒ å…³é—­</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #3498db; margin-bottom: 10px;">ğŸ“‹ è¯„åˆ†æ–¹æ¡ˆ</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <div style="font-weight: 600; margin-bottom: 5px;">${history.scheme.name}</div>
                            <div style="color: #7f8c8d; font-size: 0.9rem;">${history.scheme.description}</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #3498db; margin-bottom: 10px;">ğŸ“Š è¯„åˆ†ç»“æœ</h4>
                        ${history.summary.ranking.map((item, idx) => `
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                                <span style="font-weight: 600;">
                                    ${idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : `ç¬¬${idx + 1}å`} ${item.group}
                                </span>
                                <span style="font-weight: 600; color: #3498db;">${item.finalScore.toFixed(1)}åˆ† (${item.ratingCount}æ¬¡è¯„åˆ†)</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #3498db; margin-bottom: 10px;">ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <div style="margin-bottom: 5px;">è¯„åˆ†ç»„æ•°: ${history.summary.ratedGroups}/${history.summary.totalGroups}</div>
                            <div style="margin-bottom: 5px;">æ€»è¯„åˆ†æ¬¡æ•°: ${history.summary.totalRatings}</div>
                            <div>ç»Ÿè®¡æ–¹æ³•: ${history.scoringMethod === 'method1' ? 'å»æå€¼å¹³å‡æ³•' : 'ç®€å•å¹³å‡æ³•'}</div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="color: #3498db; margin-bottom: 10px;">ğŸ“¥ å¯¼å‡ºå†å²æ•°æ®</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn" onclick="exportHistoryToExcel(${index})" style="padding: 8px 15px;">ğŸ“Š å¯¼å‡ºExcel</button>
                            <button class="btn btn-secondary" onclick="exportHistoryToWord(${index})" style="padding: 8px 15px;">ğŸ“„ å¯¼å‡ºWord</button>
                        </div>
                    </div>
                </div>
            `;
            
            const ratingHistoryList = document.getElementById('ratingHistoryList');
            ratingHistoryList.innerHTML = detailsHtml;
        }
        
        // å…³é—­å†å²è¯¦æƒ…
        function closeHistoryDetail() {
            updateRatingHistoryList();
        }
        
        // åˆ é™¤å†å²è®°å½•
        async function deleteHistory(index) {
            const history = ratingHistory[index];
            if (!history) return;
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å†å²è®°å½•"${history.name}"å—ï¼Ÿ`)) {
                return;
            }
            
            ratingHistory.splice(index, 1);
            await saveData();
            updateRatingHistoryList();
            showMessage('âœ… å†å²è®°å½•å·²åˆ é™¤ï¼');
        }
        
        // å¯¼å‡ºå†å²åˆ°Excel
        function exportHistoryToExcel(index) {
            const history = ratingHistory[index];
            if (!history) return;
            
            try {
                const wb = XLSX.utils.book_new();
                
                const summaryData = [
                    ['å†å²è®°å½•åç§°', history.name],
                    ['ä¿å­˜æ—¶é—´', new Date(history.saveTime).toLocaleString()],
                    ['è¯„åˆ†æ–¹æ¡ˆ', history.scheme.name],
                    ['ç»Ÿè®¡æ–¹æ³•', history.scoringMethod === 'method1' ? 'å»æå€¼å¹³å‡æ³•' : 'ç®€å•å¹³å‡æ³•'],
                    [''],
                    ['æ’å', 'ç»„åˆ«', 'æœ€ç»ˆå¾—åˆ†', 'è¯„åˆ†æ¬¡æ•°']
                ];
                
                history.summary.ranking.forEach((item, idx) => {
                    summaryData.push([idx + 1, item.group, item.finalScore.toFixed(1), item.ratingCount]);
                });
                
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, wsSummary, 'è¯„åˆ†ç»“æœ');
                
                const fileName = `${history.name}_${new Date(history.saveTime).toLocaleDateString().replace(/\//g, '-')}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showMessage('âœ… å†å²æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
            } catch (error) {
                console.error('å¯¼å‡ºå†å²Excelå¤±è´¥:', error);
                showMessage('âš ï¸ å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'warning');
            }
        }
        
        // å¯¼å‡ºå†å²åˆ°Word
        function exportHistoryToWord(index) {
            const history = ratingHistory[index];
            if (!history) return;
            
            try {
                let content = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                      xmlns:w='urn:schemas-microsoft-com:office:word' 
                      xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset="utf-8">
                    <title>${history.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                        h1 { color: #2c3e50; text-align: center; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
                        h2 { color: #3498db; border-left: 4px solid #3498db; padding-left: 10px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #ddd; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background-color: #f8f9fa; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h1>${history.name}</h1>
                    <p><strong>ä¿å­˜æ—¶é—´ï¼š</strong>${new Date(history.saveTime).toLocaleString()}</p>
                    
                    <h2>ğŸ“‹ è¯„åˆ†æ–¹æ¡ˆ</h2>
                    <p><strong>æ–¹æ¡ˆåç§°ï¼š</strong>${history.scheme.name}</p>
                    <p><strong>æ–¹æ¡ˆæè¿°ï¼š</strong>${history.scheme.description}</p>
                    <p><strong>ç»Ÿè®¡æ–¹æ³•ï¼š</strong>${history.scoringMethod === 'method1' ? 'å»æå€¼å¹³å‡æ³•' : 'ç®€å•å¹³å‡æ³•'}</p>
                    
                    <h2>ğŸ“Š è¯„åˆ†ç»“æœ</h2>
                    <table>
                        <tr>
                            <th>æ’å</th>
                            <th>ç»„åˆ«</th>
                            <th>æœ€ç»ˆå¾—åˆ†</th>
                            <th>è¯„åˆ†æ¬¡æ•°</th>
                        </tr>
                `;
                
                history.summary.ranking.forEach((item, idx) => {
                    content += `
                        <tr>
                            <td>ç¬¬${idx + 1}å</td>
                            <td>${item.group}</td>
                            <td><strong>${item.finalScore.toFixed(1)}</strong></td>
                            <td>${item.ratingCount}æ¬¡</td>
                        </tr>
                    `;
                });
                
                content += `
                    </table>
                    
                    <h2>ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯</h2>
                    <p><strong>è¯„åˆ†ç»„æ•°ï¼š</strong>${history.summary.ratedGroups}/${history.summary.totalGroups}</p>
                    <p><strong>æ€»è¯„åˆ†æ¬¡æ•°ï¼š</strong>${history.summary.totalRatings}</p>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666;">
                        <p>æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}</p>
                        <p>è¯„åˆ†ç³»ç»Ÿ v1.0</p>
                    </div>
                </body>
                </html>
                `;
                
                const blob = new Blob([content], {type: 'application/msword'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${history.name}_${new Date(history.saveTime).toLocaleDateString().replace(/\//g, '-')}.doc`;
                link.click();
                
                showMessage('âœ… å†å²æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
            } catch (error) {
                console.error('å¯¼å‡ºå†å²Wordå¤±è´¥:', error);
                showMessage('âš ï¸ å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'warning');
            }
        }
        
        // æ›´æ–°å½“å‰æ–¹æ¡ˆä¿¡æ¯
        function updateCurrentSchemeInfo() {
            const activeSchemeDisplay = document.getElementById('activeSchemeDisplay');
            if (!activeSchemeDisplay) return;
            
            const scheme = ratingSchemes[currentSchemeId];
            if (!scheme) return;
            
            activeSchemeDisplay.innerHTML = `
                <div style="background: #e8f4fd; padding: 20px; border-radius: 10px;">
                    <h4 style="color: #3498db; margin-bottom: 10px;">${scheme.name}</h4>
                    <p style="color: #7f8c8d;">${scheme.description}</p>
                    <div style="margin-top: 15px;">
                        ${scheme.dimensions.map(dim => `
                            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f0f0f0;">
                                <span>${dim.name}</span>
                                <span style="color: #3498db; font-weight: 600;">${dim.weight}%</span>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #f0f0f0;">
                        <div style="color: #7f8c8d; font-size: 0.9rem;">
                            æ€»åˆ†: ${scheme.totalScore}åˆ† | åˆ›å»ºæ—¶é—´: ${new Date(scheme.createdAt).toLocaleString()}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // æ›´æ–°ç»Ÿè®¡æ–¹æ¡ˆUI
        function updateScoringMethodUI() {
            const method1Card = document.getElementById('method1Card');
            const method2Card = document.getElementById('method2Card');
            
            if (!method1Card || !method2Card) return;
            
            if (currentScoringMethod === 'method1') {
                method1Card.style.borderColor = '#3498db';
                method1Card.style.background = '#e8f4fd';
                method1Card.querySelector('div:last-child').textContent = 'å½“å‰ä½¿ç”¨ä¸­';
                method1Card.querySelector('div:last-child').style.color = '#3498db';
                
                method2Card.style.borderColor = '#e9ecef';
                method2Card.style.background = 'white';
                method2Card.querySelector('div:last-child').textContent = 'ç‚¹å‡»é€‰æ‹©';
                method2Card.querySelector('div:last-child').style.color = '#7f8c8d';
            } else {
                method2Card.style.borderColor = '#3498db';
                method2Card.style.background = '#e8f4fd';
                method2Card.querySelector('div:last-child').textContent = 'å½“å‰ä½¿ç”¨ä¸­';
                method2Card.querySelector('div:last-child').style.color = '#3498db';
                
                method1Card.style.borderColor = '#e9ecef';
                method1Card.style.background = 'white';
                method1Card.querySelector('div:last-child').textContent = 'ç‚¹å‡»é€‰æ‹©';
                method1Card.querySelector('div:last-child').style.color = '#7f8c8d';
            }
        }

        // é€‰æ‹©ç»Ÿè®¡æ–¹æ¡ˆ
        function selectScoringMethod(method) {
            const method1Card = document.getElementById('method1Card');
            const method2Card = document.getElementById('method2Card');
            
            if (method === 'method1') {
                method1Card.style.borderColor = '#3498db';
                method1Card.style.background = '#e8f4fd';
                method1Card.querySelector('div:last-child').textContent = 'å½“å‰ä½¿ç”¨ä¸­';
                method1Card.querySelector('div:last-child').style.color = '#3498db';
                
                method2Card.style.borderColor = '#e9ecef';
                method2Card.style.background = 'white';
                method2Card.querySelector('div:last-child').textContent = 'ç‚¹å‡»é€‰æ‹©';
                method2Card.querySelector('div:last-child').style.color = '#7f8c8d';
            } else {
                method2Card.style.borderColor = '#3498db';
                method2Card.style.background = '#e8f4fd';
                method2Card.querySelector('div:last-child').textContent = 'å½“å‰ä½¿ç”¨ä¸­';
                method2Card.querySelector('div:last-child').style.color = '#3498db';
                
                method1Card.style.borderColor = '#e9ecef';
                method1Card.style.background = 'white';
                method1Card.querySelector('div:last-child').textContent = 'ç‚¹å‡»é€‰æ‹©';
                method1Card.querySelector('div:last-child').style.color = '#7f8c8d';
            }
        }
        
        // åº”ç”¨ç»Ÿè®¡æ–¹æ¡ˆ
        async function applyScoringMethod() {
            const method1Card = document.getElementById('method1Card');
            const method2Card = document.getElementById('method2Card');
            
            if (method1Card.style.borderColor === 'rgb(52, 152, 219)') {
                currentScoringMethod = 'method1';
            } else if (method2Card.style.borderColor === 'rgb(52, 152, 219)') {
                currentScoringMethod = 'method2';
            }
            
            await saveData();
            calculateFinalScores();
            updateAllResults();
            updateShareLinks();
            showMessage('âœ… ç»Ÿè®¡æ–¹æ¡ˆå·²åº”ç”¨ï¼');
        }
        
        // æ›´æ–°åˆ†äº«é“¾æ¥
        function updateShareLinks() {
            const baseUrl = window.location.href.split('#')[0];
            
            // ç®¡ç†ç‰ˆé“¾æ¥
            const adminUrl = baseUrl;
            
            // è¯„åˆ†ç‰ˆé“¾æ¥ï¼ˆåŒ…å«è¯„åˆ†æ–¹æ¡ˆå’Œç»Ÿè®¡æ–¹æ¡ˆï¼‰
            const ratingUrl = baseUrl + `#mobile&scheme=${currentSchemeId}&scoring=${currentScoringMethod}`;
            
            document.getElementById('adminLink').textContent = adminUrl;
            document.getElementById('ratingLink').textContent = ratingUrl;
        }
        
        // å¤åˆ¶ç®¡ç†ç‰ˆé“¾æ¥
        function copyAdminLink() {
            const link = window.location.href.split('#')[0];
            copyToClipboard(link, 'âœ… ç®¡ç†ç‰ˆé“¾æ¥å·²å¤åˆ¶ï¼');
        }
        
        // å¤åˆ¶è¯„åˆ†ç‰ˆé“¾æ¥
        function copyRatingLink() {
            const link = window.location.href.split('#')[0] + '#mobile';
            copyToClipboard(link, 'âœ… è¯„åˆ†ç‰ˆé“¾æ¥å·²å¤åˆ¶ï¼è¯·åˆ†äº«ç»™è¯„å§”ã€‚');
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text, successMessage) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showMessage(successMessage);
                }).catch(() => {
                    fallbackCopy(text, successMessage);
                });
            } else {
                fallbackCopy(text, successMessage);
            }
        }
        
        // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
        function fallbackCopy(text, successMessage) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showMessage(successMessage);
        }
        
        // é€‰æ‹©è¯„åˆ†ç»„
function selectGroup(groupName) {
    if (hasUserRated(groupName)) {
        showReviewPage(groupName);
        return;
    }
    
    currentRatingGroup = groupName;
    createRatingPage(groupName);
}
        
        // åˆ›å»ºè¯„åˆ†é¡µé¢
        function createRatingPage(groupName) {
            const ratingPage = document.getElementById('mobileRatingPage');
            const scheme = ratingSchemes[currentSchemeId];
            
            if (!scheme) {
                showMessage('âš ï¸ è¯„åˆ†æ–¹æ¡ˆæœªæ‰¾åˆ°', 'warning');
                return;
            }
            
            let dimensionsHTML = '';
            scheme.dimensions.forEach((dimension, index) => {
                dimensionsHTML += `
                    <div class="rating-item">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <span style="font-weight: 600;">${dimension.name} (${dimension.weight}%)</span>
                            <span id="score${index}Value" style="font-weight: 600; color: #3498db;">${dimension.minScore}</span>
                        </div>
                        <input type="range" min="${dimension.minScore}" max="${dimension.maxScore}" step="0.5" 
                               value="${dimension.minScore}" class="dimension-slider" id="score${index}">
                        <div style="display: flex; justify-content: space-between; color: #7f8c8d; font-size: 0.9rem; margin-top: 10px; font-weight: 600;">
                            <span>${dimension.minScore}åˆ†</span>
                            <span>${(dimension.minScore + dimension.maxScore) / 2}åˆ†</span>
                            <span>${dimension.maxScore}åˆ†</span>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9rem; color: #7f8c8d;">
                            ${dimension.scoreLevels.map(level => `${level.score}åˆ†: ${level.description}`).join(' | ')}
                        </div>
                    </div>
                `;
            });
            
            ratingPage.innerHTML = `
                <div class="page-header">
                    <h1>${groupName} è¯„åˆ†</h1>
                    <p>ä½¿ç”¨æ–¹æ¡ˆ: ${scheme.name}</p>
                </div>
                
                <div class="mobile-content">
                    ${dimensionsHTML}
                    
                    <!-- æ€»åˆ†æ˜¾ç¤º -->
                    <div class="total-score">
                        <div style="font-size: 1.1rem; margin-bottom: 5px;">åŠ æƒæ€»åˆ†</div>
                        <div style="font-size: 2.5rem; font-weight: 800;" id="totalScore">0.0</div>
                        <div style="margin-top: 10px; font-size: 0.85rem; opacity: 0.9;">
                            ï¼ˆå·²è‡ªåŠ¨è®¡ç®—åŠ æƒæ€»åˆ†ï¼‰
                        </div>
                    </div>
                    
                    <!-- æäº¤æŒ‰é’® -->
                    <button class="submit-btn" onclick="submitRating()" id="submitBtn">
                        ğŸ“¤ æäº¤è¯„åˆ†
                    </button>
                    
                    <!-- è¿”å›æŒ‰é’® -->
                    <button class="submit-btn" onclick="showMobilePage('group')" style="background: #95a5a6; margin-top: 10px;">
                        â†©ï¸ è¿”å›é€‰æ‹©
                    </button>
                </div>
            `;
            
            // ç»‘å®šæ»‘å—äº‹ä»¶
            bindSliderEvents(scheme.dimensions.length);
            
            // æ˜¾ç¤ºè¯„åˆ†é¡µé¢
            showMobilePage('rating');
        }
        
        // åˆ›å»ºæŸ¥çœ‹è¯„åˆ†é¡µé¢
function showReviewPage(groupName) {
    const reviewPage = document.getElementById('mobileReviewPage');
    const userScore = getUserRating(groupName);
    const scheme = ratingSchemes[currentSchemeId];
    
    if (!userScore || !scheme) {
        showMessage('âš ï¸ è¯„åˆ†æ•°æ®æœªæ‰¾åˆ°', 'warning');
        return;
    }
            
            let reviewItemsHTML = '';
            scheme.dimensions.forEach((dimension, index) => {
                const score = userScore[`dimension${index}`] || 0;
                reviewItemsHTML += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding: 8px 0; border-bottom: 1px solid #f8f9fa;">
                        <span style="font-weight: 600; color: #2c3e50;">${dimension.name} (${dimension.weight}%)</span>
                        <span style="color: #3498db; font-weight: 600;">${score}</span>
                    </div>
                `;
            });
            
            reviewPage.innerHTML = `
                <div class="page-header">
                    <h1>${groupName} è¯„åˆ†è¯¦æƒ…</h1>
                    <p>æ‚¨å·²å®Œæˆçš„è¯„åˆ†</p>
                </div>
                
                <div class="mobile-content">
                    <div style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                            <h3>æ‚¨çš„è¯„åˆ†</h3>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #3498db;">${userScore.total.toFixed(1)}</div>
                        </div>
                        
                        ${reviewItemsHTML}
                        
                        <div style="display: flex; justify-content: space-between; padding-top: 10px; margin-top: 10px; border-top: 1px solid #eee;">
                            <span style="font-weight: 700;">åŠ æƒæ€»åˆ†</span>
                            <span style="font-weight: 700; color: #3498db;">${userScore.total.toFixed(1)}</span>
                        </div>
                    </div>
                    
                    <button class="submit-btn" onclick="requestReRating('${groupName}')" style="background: #f39c12; margin-bottom: 10px;">
                        ğŸ”„ ç”³è¯·é‡è¯„
                    </button>
                    
                    <!-- è¿”å›æŒ‰é’® -->
                    <button class="submit-btn" onclick="showMobilePage('group')" style="background: #95a5a6; margin-top: 10px;">
                        â†©ï¸ è¿”å›é€‰æ‹©
                    </button>
                </div>
            `;
            
            // æ˜¾ç¤ºæŸ¥çœ‹è¯„åˆ†é¡µé¢
            showMobilePage('review');
        }
        
        // ç»‘å®šæ»‘å—äº‹ä»¶
        function bindSliderEvents(dimensionCount) {
            for (let i = 0; i < dimensionCount; i++) {
                const slider = document.getElementById('score' + i);
                if (slider) {
                    slider.addEventListener('input', function() {
                        document.getElementById('score' + i + 'Value').textContent = slider.value;
                        updateTotalScore(dimensionCount);
                    });
                }
            }
        }
        
        // æ›´æ–°æ€»åˆ†
function updateTotalScore(dimensionCount) {
    const scheme = ratingSchemes[currentSchemeId];
    if (!scheme) return;
    
    let total = 0;
    scheme.dimensions.forEach((dimension, index) => {
        const slider = document.getElementById('score' + index);
        if (slider) {
            const score = parseFloat(slider.value);
            // è®¡ç®—åŠ æƒåˆ†æ•°ï¼š(åˆ†æ•° / æœ€å¤§åˆ†) * æƒé‡ * æ€»åˆ† / 100
            const weightedScore = (score / dimension.maxScore) * dimension.weight * scheme.totalScore / 100;
            total += weightedScore;
        }
    });
    
    if (document.getElementById('totalScore')) {
        document.getElementById('totalScore').textContent = total.toFixed(1);
    }
}

// æ˜¾ç¤ºæ‰‹æœºç«¯é¡µé¢
function showMobilePage(pageName) {
    // éšè—æ‰€æœ‰æ‰‹æœºç«¯é¡µé¢
    document.querySelectorAll('#mobilePage .page').forEach(page => {
        page.classList.remove('active');
    });
    
    // æ˜¾ç¤ºç›®æ ‡é¡µé¢
    document.getElementById('mobile' + pageName.charAt(0).toUpperCase() + pageName.slice(1) + 'Page').classList.add('active');
}

// ç”³è¯·é‡è¯„
async function requestReRating(groupName) {
            const userId = getCurrentUserId();
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å¾…å¤„ç†çš„é‡è¯„è¯·æ±‚
            const existingRequest = reRatingRequests.find(req => 
                req.userId === userId && req.groupName === groupName && req.status === 'pending'
            );
            
            if (existingRequest) {
                showMessage('âš ï¸ æ‚¨å·²æäº¤é‡è¯„ç”³è¯·ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹', 'warning');
                return;
            }
            
            // åˆ›å»ºé‡è¯„è¯·æ±‚
            const request = {
                id: 'req_' + Date.now(),
                userId: userId,
                userName: 'è¯„å§”' + userId.substring(0, 8),
                groupName: groupName,
                requestTime: new Date().getTime(),
                status: 'pending'
            };
            
            reRatingRequests.push(request);
            await saveData();
            updateMyReRatingRequests();
            showMessage('âœ… é‡è¯„ç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹');
        }
        
        // æ›´æ–°è¯„å§”ç«¯é‡è¯„è¯·æ±‚åˆ—è¡¨
        function updateMyReRatingRequests() {
            const myReRatingRequestsDiv = document.getElementById('myReRatingRequests');
            if (!myReRatingRequestsDiv) return;
            
            const userId = getCurrentUserId();
            const myRequests = reRatingRequests.filter(req => req.userId === userId);
            
            if (myRequests.length === 0) {
                myReRatingRequestsDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #7f8c8d;">æš‚æ— é‡è¯„è¯·æ±‚</p>';
                return;
            }
            
            let html = '';
            myRequests.forEach(request => {
                let statusText = '';
                let statusColor = '';
                let actionText = '';
                
                if (request.status === 'pending') {
                    statusText = 'â³ å¾…å®¡æ‰¹';
                    statusColor = '#f39c12';
                    actionText = 'è¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹';
                } else if (request.status === 'approved') {
                    statusText = 'âœ… å·²æ‰¹å‡†';
                    statusColor = '#2ecc71';
                    actionText = 'ç°åœ¨å¯ä»¥é‡æ–°è¯„åˆ†äº†ï¼';
                } else if (request.status === 'rejected') {
                    statusText = 'âŒ å·²æ‹’ç»';
                    statusColor = '#e74c3c';
                    actionText = 'é‡è¯„ç”³è¯·è¢«æ‹’ç»';
                }
                
                html += `
                    <div style="background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 700; color: #2c3e50;">${request.groupName}</div>
                                <div style="color: #7f8c8d; font-size: 0.85rem;">
                                    ${new Date(request.requestTime).toLocaleString()}
                                </div>
                            </div>
                            <div style="font-weight: 600; color: ${statusColor}; font-size: 0.9rem;">
                                ${statusText}
                            </div>
                        </div>
                        <div style="color: #7f8c8d; font-size: 0.9rem; text-align: center;">
                            ${actionText}
                        </div>
                    </div>
                `;
            });
            
            myReRatingRequestsDiv.innerHTML = html;
        }
        
        // æäº¤è¯„åˆ†
        async function submitRating() {
            if (isSubmitting) {
                showMessage('âš ï¸ æ­£åœ¨æäº¤ä¸­ï¼Œè¯·ç¨å€™...', 'warning');
                return;
            }
            
            if (!currentRatingGroup) {
                showMessage('âš ï¸ è¯·å…ˆé€‰æ‹©è¦è¯„åˆ†çš„ç»„åˆ«', 'warning');
                return;
            }
            
            const scheme = ratingSchemes[currentSchemeId];
            if (!scheme) {
                showMessage('âš ï¸ è¯„åˆ†æ–¹æ¡ˆæœªæ‰¾åˆ°', 'warning');
                return;
            }
            
            isSubmitting = true;
            const submitBtn = document.getElementById('submitBtn');
            const groupName = currentRatingGroup;
            
            // ç¦ç”¨æäº¤æŒ‰é’®
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';
            
            // æ”¶é›†è¯„åˆ†æ•°æ®
            const rating = {
                timestamp: new Date().getTime(),
                schemeId: currentSchemeId,
                total: parseFloat(document.getElementById('totalScore').textContent),
                userId: getCurrentUserId()
            };
            
            // æ·»åŠ å„ç»´åº¦åˆ†æ•°
            scheme.dimensions.forEach((dimension, index) => {
                const slider = document.getElementById('score' + index);
                if (slider) {
                    rating[`dimension${index}`] = parseFloat(slider.value);
                }
            });
            
            console.log('æäº¤è¯„åˆ†:', rating);
            
            // ä¿å­˜è¯„åˆ†åˆ°äº‘ç«¯
            groupsData[groupName].scores.push(rating);
            
            // é‡æ–°è®¡ç®—æœ€ç»ˆå¾—åˆ†
            calculateFinalScores();
            
            // ä¿å­˜æ•°æ®åˆ°äº‘ç«¯
            const saveSuccess = await saveData();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            if (saveSuccess) {
                showMessage('âœ… ' + groupName + ' è¯„åˆ†æäº¤æˆåŠŸï¼');
            } else {
                showMessage('âš ï¸ ' + groupName + ' è¯„åˆ†å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œä½†äº‘ç«¯åŒæ­¥å¤±è´¥', 'warning');
            }
            
            // 3ç§’åè¿”å›é€‰æ‹©é¡µé¢
            setTimeout(() => {
                // æ¢å¤æäº¤æŒ‰é’®
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸ“¤ æäº¤è¯„åˆ†';
                
                // è¿”å›é€‰æ‹©é¡µé¢å¹¶æ›´æ–°çŠ¶æ€
                showMobilePage('group');
                updateGroupSelection();
                updateMyReRatingRequests();
                
                isSubmitting = false;
                
            }, 3000);
        }

// æ›´æ–°ç»„é€‰æ‹©ç•Œé¢
function updateGroupSelection() {
    const groupSelectionContainer = document.getElementById('groupSelectionContainer');
    if (!groupSelectionContainer) return;
    
    groupSelectionContainer.innerHTML = '';
    
    let completedCount = 0;
    
    groupNames.forEach((groupName, index) => {
        const groupBtn = document.createElement('div');
        groupBtn.className = 'group-btn';
        groupBtn.id = 'groupBtn' + (index + 1);
        
        const hasRated = hasUserRated(groupName);
        const icon = index === 0 ? 'ğŸ§´' : 'ğŸ’†';
        
        if (hasRated) {
            groupBtn.classList.add('completed');
            completedCount++;
        }
        
        groupBtn.innerHTML = `
            <div style="font-size: 2rem;">${icon}</div>
            <div style="font-weight: 600; margin: 10px 0;">${groupName}</div>
            <div style="font-size: 0.9rem; opacity: 0.8;" id="groupStatus${index + 1}">${hasRated ? 'å·²è¯„åˆ† âœ“' : 'å¾…è¯„åˆ†'}</div>
        `;
        
        groupBtn.onclick = function() {
            selectGroup(groupName);
        };
        
        groupSelectionContainer.appendChild(groupBtn);
    });
    
    // æ›´æ–°è¿›åº¦
    const completedCountElement = document.getElementById('completedCount');
    if (completedCountElement) {
        completedCountElement.textContent = `${completedCount}/${groupNames.length}`;
    }
}

// è®¡ç®—æœ€ç»ˆå¾—åˆ†
function calculateFinalScores() {
    Object.keys(groupsData).forEach(groupName => {
        const group = groupsData[groupName];
        const scores = group.scores;
        
        if (scores.length === 0) {
            group.finalScore = 0;
            return;
        }
        
        if (currentScoringMethod === "method1") {
            if (scores.length <= 2) {
                const sum = scores.reduce((total, score) => total + score.total, 0);
                group.finalScore = sum / scores.length;
                return;
            }
            
            const sortedScores = [...scores].sort((a, b) => a.total - b.total);
            const filteredScores = sortedScores.slice(1, sortedScores.length - 1);
            const sum = filteredScores.reduce((total, score) => total + score.total, 0);
            group.finalScore = sum / filteredScores.length;
        } else if (currentScoringMethod === "method2") {
            const sum = scores.reduce((total, score) => total + score.total, 0);
            group.finalScore = sum / scores.length;
        }
    });
}

// æ›´æ–°æ‰€æœ‰ç»“æœ
function updateAllResults() {
    // è®¡ç®—ç»Ÿè®¡æ•°æ®
    let totalRatings = 0;
    let totalScoreSum = 0;
    let completedGroups = 0;
    let highestScore = 0;
    
    Object.keys(groupsData).forEach(groupName => {
        const group = groupsData[groupName];
        totalRatings += group.scores.length;
        totalScoreSum += group.finalScore;
        
        if (group.scores.length > 0) {
            completedGroups++;
        }
        
        if (group.finalScore > highestScore) {
            highestScore = group.finalScore;
        }
    });
    
    const avgTotalScore = Object.keys(groupsData).length > 0 
        ? (totalScoreSum / Object.keys(groupsData).length).toFixed(1) 
        : "0.0";
    
    // æ›´æ–°é¦–é¡µç»Ÿè®¡æ•°æ®
    document.getElementById('adminTotalRatings').textContent = totalRatings;
    document.getElementById('adminAvgScore').textContent = avgTotalScore;
    document.getElementById('adminCompleted').textContent = `${completedGroups}/${groupNames.length}`;
    
    // æ›´æ–°ç»“æœé¡µé¢ç»Ÿè®¡æ•°æ®
    document.getElementById('resultsTotalRatings').textContent = totalRatings;
    document.getElementById('resultsAvgScore').textContent = avgTotalScore;
    document.getElementById('resultsCompleted').textContent = `${completedGroups}/${groupNames.length}`;
    document.getElementById('resultsHighest').textContent = highestScore.toFixed(1);
    
    // æ›´æ–°å½“å‰ç»Ÿè®¡æ–¹æ¡ˆæ˜¾ç¤º
    const scoringMethodDisplay = document.getElementById('currentScoringMethodDisplay');
    if (scoringMethodDisplay) {
        if (currentScoringMethod === 'method1') {
            scoringMethodDisplay.textContent = 'æ–¹æ¡ˆ1 - å»æå€¼å¹³å‡æ³•';
        } else {
            scoringMethodDisplay.textContent = 'æ–¹æ¡ˆ2 - ç®€å•å¹³å‡æ³•';
        }
    }
    
    // æ›´æ–°æ’åæ˜¾ç¤º
    updateRankingResults();
    
    // æ›´æ–°æ‰‹æœºç«¯è¿›åº¦
    updateGroupSelection();
}

// æ›´æ–°æ’åæ˜¾ç¤º
function updateRankingResults() {
    const rankingResults = document.getElementById('rankingResults');
    if (!rankingResults) return;
    
    const sortedGroups = Object.keys(groupsData).sort((a, b) => 
        groupsData[b].finalScore - groupsData[a].finalScore
    );
    
    if (sortedGroups.some(groupName => groupsData[groupName].scores.length > 0)) {
        let html = '';
        sortedGroups.forEach((groupName, index) => {
            const group = groupsData[groupName];
            
            html += `
            <div class="mobile-content" style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <div>
                        <div style="font-weight: 600; color: #2c3e50;">${groupName}</div>
                        <div style="color: #7f8c8d; font-size: 0.9rem;">è¯„åˆ†æ¬¡æ•°: ${group.scores.length}æ¬¡</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #3498db;">${group.finalScore.toFixed(1)}</div>
                        <div style="color: #7f8c8d; font-size: 0.8rem;">ç¬¬${index + 1}å</div>
                    </div>
                </div>
            </div>
            `;
        });
        rankingResults.innerHTML = html;
    } else {
        rankingResults.innerHTML = '<p style="text-align: center; padding: 40px; color: #7f8c8d;">æš‚æ— è¯„åˆ†æ•°æ®ï¼Œè¯·ç­‰å¾…è¯„å§”æäº¤è¯„åˆ†...</p>';
    }
}

// åŒæ­¥æ•°æ®
async function syncData() {
    showMessage('ğŸ“Š æ­£åœ¨åŒæ­¥æ•°æ®...', 'info');
    await loadData();
    updateAllResults();
    updateGroupSelection();
    updateReRatingRequestsList();
    setTimeout(() => {
        showMessage('âœ… æ•°æ®åŒæ­¥å®Œæˆï¼');
    }, 1000);
}

// å¯¼å‡ºä¸ºExcelï¼ˆåŒ…å«è¯¦ç»†è¯„åˆ†å’Œæœ€ç»ˆç»“æœï¼‰
function exportToExcel() {
    try {
        // åˆ›å»ºå·¥ä½œç°¿
        const wb = XLSX.utils.book_new();
        
        // 1. åˆ›å»ºè¯¦ç»†è¯„åˆ†å·¥ä½œè¡¨
        const ratingData = [];
        
        // æ·»åŠ è¯¦ç»†è¯„åˆ†è¡¨å¤´
        ratingData.push([
            'è¯„å§”ID', 'ç»„åˆ«', 'è¯„åˆ†æ—¶é—´', 'è¯„åˆ†æ–¹æ¡ˆ', 'æ€»åˆ†'
        ]);
        
        // æ·»åŠ è¯¦ç»†è¯„åˆ†æ•°æ®
        Object.keys(groupsData).forEach(groupName => {
            const group = groupsData[groupName];
            group.scores.forEach(score => {
                const scheme = ratingSchemes[score.schemeId] || { name: 'æœªçŸ¥æ–¹æ¡ˆ' };
                ratingData.push([
                    score.userId,
                    groupName,
                    new Date(score.timestamp).toLocaleString(),
                    scheme.name,
                    score.total
                ]);
            });
        });
        
        const wsDetails = XLSX.utils.aoa_to_sheet(ratingData);
        XLSX.utils.book_append_sheet(wb, wsDetails, 'è¯¦ç»†è¯„åˆ†è®°å½•');
        
        // 2. åˆ›å»ºæœ€ç»ˆç»“æœæ±‡æ€»å·¥ä½œè¡¨
        const summaryData = [
            ['ç»„åˆ«', 'è¯„åˆ†æ¬¡æ•°', 'æœ€ç»ˆå¾—åˆ†', 'æ’å', 'è¯„å§”è¯„åˆ†è¯¦æƒ…']
        ];
        
        Object.keys(groupsData)
            .sort((a, b) => groupsData[b].finalScore - groupsData[a].finalScore)
            .forEach((groupName, index) => {
                const group = groupsData[groupName];
                let scoreDetails = '';
                
                // ç”Ÿæˆè¯„åˆ†è¯¦æƒ…ï¼ˆè¯„å§”ID: åˆ†æ•°ï¼‰
                group.scores.forEach((score, idx) => {
                    scoreDetails += `è¯„å§”${idx + 1}(${score.userId.substring(0, 8)}): ${score.total}åˆ†`;
                    if (idx < group.scores.length - 1) scoreDetails += ', ';
                });
                
                summaryData.push([
                    groupName,
                    group.scores.length,
                    group.finalScore.toFixed(1),
                    index + 1,
                    scoreDetails
                ]);
            });
        
        const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, wsSummary, 'æœ€ç»ˆç»“æœæ±‡æ€»');
        
        // 3. åˆ›å»ºè¯„å§”ç»Ÿè®¡å·¥ä½œè¡¨
        const judgeStats = [['è¯„å§”ID', 'è¯„åˆ†æ¬¡æ•°', 'å¹³å‡åˆ†æ•°', 'è¯„åˆ†ç»„åˆ«']];
        
        // ç»Ÿè®¡æ¯ä¸ªè¯„å§”çš„æ•°æ®
        const judgeData = {};
        Object.keys(groupsData).forEach(groupName => {
            groupsData[groupName].scores.forEach(score => {
                if (!judgeData[score.userId]) {
                    judgeData[score.userId] = {
                        count: 0,
                        totalScore: 0,
                        groups: new Set()
                    };
                }
                judgeData[score.userId].count++;
                judgeData[score.userId].totalScore += score.total;
                judgeData[score.userId].groups.add(groupName);
            });
        });
        
        Object.keys(judgeData).forEach(judgeId => {
            const data = judgeData[judgeId];
            judgeStats.push([
                judgeId,
                data.count,
                (data.totalScore / data.count).toFixed(1),
                Array.from(data.groups).join(', ')
            ]);
        });
        
        const wsJudges = XLSX.utils.aoa_to_sheet(judgeStats);
        XLSX.utils.book_append_sheet(wb, wsJudges, 'è¯„å§”ç»Ÿè®¡');
        
        // ç”ŸæˆExcelæ–‡ä»¶å¹¶ä¸‹è½½
        const fileName = `è¯„åˆ†ç³»ç»Ÿå®Œæ•´æ•°æ®_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        showMessage('âœ… Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼åŒ…å«è¯¦ç»†è¯„åˆ†å’Œæœ€ç»ˆç»“æœ');
    } catch (error) {
        console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
        showMessage('âš ï¸ Excelæ–‡ä»¶å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'warning');
    }
}

// å¯¼å‡ºä¸ºWordï¼ˆåŒ…å«è¯¦ç»†è¯„åˆ†å’Œæœ€ç»ˆç»“æœï¼‰
function exportToWord() {
    try {
        let content = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' 
              xmlns:w='urn:schemas-microsoft-com:office:word' 
              xmlns='http://www.w3.org/TR/REC-html40'>
        <head>
            <meta charset="utf-8">
            <title>è¯„åˆ†ç³»ç»Ÿå®Œæ•´æŠ¥å‘Š</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                h1 { color: #2c3e50; text-align: center; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
                h2 { color: #3498db; border-left: 4px solid #3498db; padding-left: 10px; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #ddd; }
                th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                th { background-color: #f8f9fa; font-weight: bold; }
                .judge-score { background-color: #f0f8f0; padding: 8px; margin: 5px 0; border-radius: 3px; }
            </style>
        </head>
        <body>
            <h1>æ´—æŠ¤/æŠ¤è‚¤ç»„æ¯”èµ›è¯„åˆ†ç³»ç»Ÿå®Œæ•´æŠ¥å‘Š</h1>
            <p><strong>å¯¼å‡ºæ—¶é—´ï¼š</strong>${new Date().toLocaleString()}</p>
            
            <h2>ğŸ“Š æœ€ç»ˆç»“æœæ±‡æ€»</h2>
            <table>
                <tr>
                    <th>æ’å</th>
                    <th>ç»„åˆ«</th>
                    <th>æœ€ç»ˆå¾—åˆ†</th>
                    <th>è¯„åˆ†æ¬¡æ•°</th>
                    <th>è¯„å§”è¯„åˆ†è¯¦æƒ…</th>
                </tr>
        `;
        
        // æ·»åŠ æœ€ç»ˆç»“æœ
        Object.keys(groupsData)
            .sort((a, b) => groupsData[b].finalScore - groupsData[a].finalScore)
            .forEach((groupName, index) => {
                const group = groupsData[groupName];
                let judgeDetails = '';
                
                group.scores.forEach((score, idx) => {
                    judgeDetails += `<div class="judge-score">è¯„å§”${idx + 1} (${score.userId.substring(0, 8)}): ${score.total}åˆ†</div>`;
                });
                
                content += `
                <tr>
                    <td>ç¬¬${index + 1}å</td>
                    <td>${groupName}</td>
                    <td><strong>${group.finalScore.toFixed(1)}</strong></td>
                    <td>${group.scores.length}æ¬¡</td>
                    <td>${judgeDetails}</td>
                </tr>
                `;
            });
        
        content += `
            </table>
            
            <h2>ğŸ“ è¯¦ç»†è¯„åˆ†è®°å½•</h2>
            <table>
                <tr>
                    <th>è¯„å§”ID</th>
                    <th>ç»„åˆ«</th>
                    <th>è¯„åˆ†æ—¶é—´</th>
                    <th>è¯„åˆ†æ–¹æ¡ˆ</th>
                    <th>æ€»åˆ†</th>
                </tr>
        `;
        
        // æ·»åŠ è¯¦ç»†è¯„åˆ†æ•°æ®
        Object.keys(groupsData).forEach(groupName => {
            const group = groupsData[groupName];
            group.scores.forEach(score => {
                const scheme = ratingSchemes[score.schemeId] || { name: 'æœªçŸ¥æ–¹æ¡ˆ' };
                content += `
                <tr>
                    <td>${score.userId}</td>
                    <td>${groupName}</td>
                    <td>${new Date(score.timestamp).toLocaleString()}</td>
                    <td>${scheme.name}</td>
                    <td>${score.total}</td>
                </tr>
                `;
            });
        });
        
        content += `
            </table>
            
            <h2>ğŸ‘¥ è¯„å§”ç»Ÿè®¡</h2>
            <table>
                <tr>
                    <th>è¯„å§”ID</th>
                    <th>è¯„åˆ†æ¬¡æ•°</th>
                    <th>å¹³å‡åˆ†æ•°</th>
                    <th>è¯„åˆ†ç»„åˆ«</th>
                </tr>
        `;
        
        // ç»Ÿè®¡è¯„å§”æ•°æ®
        const judgeData = {};
        Object.keys(groupsData).forEach(groupName => {
            groupsData[groupName].scores.forEach(score => {
                if (!judgeData[score.userId]) {
                    judgeData[score.userId] = {
                        count: 0,
                        totalScore: 0,
                        groups: new Set()
                    };
                }
                judgeData[score.userId].count++;
                judgeData[score.userId].totalScore += score.total;
                judgeData[score.userId].groups.add(groupName);
            });
        });
        
        Object.keys(judgeData).forEach(judgeId => {
            const data = judgeData[judgeId];
            content += `
                <tr>
                    <td>${judgeId}</td>
                    <td>${data.count}</td>
                    <td>${(data.totalScore / data.count).toFixed(1)}</td>
                    <td>${Array.from(data.groups).join(', ')}</td>
                </tr>
            `;
        });
        
        content += `
            </table>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666;">
                <p>æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}</p>
                <p>è¯„åˆ†ç³»ç»Ÿ v1.0 - æ´—æŠ¤/æŠ¤è‚¤ç»„æ¯”èµ›</p>
            </div>
        </body>
        </html>
        `;
        
        // åˆ›å»ºBlobå¹¶ä¸‹è½½
        const blob = new Blob([content], {type: 'application/msword'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `è¯„åˆ†ç³»ç»Ÿå®Œæ•´æŠ¥å‘Š_${new Date().toLocaleDateString().replace(/\//g, '-')}.doc`;
        link.click();
        
        showMessage('âœ… Wordæ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼åŒ…å«è¯¦ç»†è¯„åˆ†å’Œæœ€ç»ˆç»“æœ');
    } catch (error) {
        console.error('å¯¼å‡ºWordå¤±è´¥:', error);
        showMessage('âš ï¸ Wordæ–‡ä»¶å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'warning');
    }
}

// å¯¼å‡ºä¸ºJSON
function exportToJSON() {
    const exportData = {
        exportTime: new Date().toLocaleString(),
        groupsData: groupsData,
        ratingSchemes: ratingSchemes,
        currentSchemeId: currentSchemeId,
        summary: getExportSummary()
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `è¯„åˆ†ç³»ç»Ÿå®Œæ•´æ•°æ®_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
    link.click();
    showMessage('âœ… JSONæ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼åŒ…å«å®Œæ•´è¯„åˆ†æ•°æ®');
}

// è·å–å¯¼å‡ºæ‘˜è¦ä¿¡æ¯
function getExportSummary() {
    const summary = {
        totalRatings: 0,
        totalGroups: Object.keys(groupsData).length,
        ratedGroups: 0,
        totalJudges: new Set(),
        ranking: []
    };
    
    Object.keys(groupsData).forEach(groupName => {
        const group = groupsData[groupName];
        summary.totalRatings += group.scores.length;
        
        if (group.scores.length > 0) {
            summary.ratedGroups++;
        }
        
        group.scores.forEach(score => {
            summary.totalJudges.add(score.userId);
        });
        
        summary.ranking.push({
            group: groupName,
            finalScore: group.finalScore,
            ratingCount: group.scores.length,
            judges: group.scores.map(score => score.userId)
        });
    });
    
    summary.ranking.sort((a, b) => b.finalScore - a.finalScore);
    summary.totalJudges = summary.totalJudges.size;
    
    return summary;
}

// ä¿å­˜æ•°æ®åˆ° JSONBin.io
        async function saveData() {
            const dataToSave = {
                groupsData,
                ratingSchemes,
                currentSchemeId,
                currentScoringMethod,
                groupNames,
                reRatingRequests,
                ratingHistory,
                lastUpdate: new Date().getTime()
            };
            
            // å…ˆä¿å­˜åˆ° localStorage ä½œä¸ºå¤‡ä»½
            localStorage.setItem('ratingSystemData', JSON.stringify(dataToSave));
            
            let retryCount = 0;
            const maxRetries = 3;
            
            while (retryCount < maxRetries) {
                try {
                    const response = await axios.put(JSONBIN_API_URL, dataToSave, {
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_API_KEY
                        },
                        timeout: 10000 // 10ç§’è¶…æ—¶
                    });
                    
                    console.log('æ•°æ®ä¿å­˜åˆ° JSONBin.io æˆåŠŸ');
                    return true;
                } catch (e) {
                    console.error('ä¿å­˜åˆ° JSONBin.io å¤±è´¥ (å°è¯• ' + (retryCount + 1) + '/' + maxRetries + '):', e);
                    retryCount++;
                    
                    if (retryCount < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, 2000)); // ç­‰å¾…2ç§’åé‡è¯•
                    }
                }
            }
            
            // å¦‚æœæ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œåªä½¿ç”¨æœ¬åœ°å­˜å‚¨
            showMessage('âš ï¸ äº‘ç«¯ä¿å­˜å¤±è´¥ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°ã€‚æ•°æ®å¯èƒ½ä¸ä¼šåŒæ­¥åˆ°å…¶ä»–è®¾å¤‡ã€‚', 'warning');
            return false;
        }
        
        // ä» JSONBin.io åŠ è½½æ•°æ®
        async function loadData() {
            let loadedData = null;
            let cloudSuccess = false;
            
            // å…ˆå°è¯•ä»æœ¬åœ°åŠ è½½
            try {
                const savedData = localStorage.getItem('ratingSystemData');
                if (savedData) {
                    loadedData = JSON.parse(savedData);
                    console.log('ä» localStorage åŠ è½½æ•°æ®æˆåŠŸ');
                }
            } catch (localError) {
                console.error('ä» localStorage åŠ è½½æ•°æ®å¤±è´¥:', localError);
            }
            
            // å†å°è¯•ä»äº‘ç«¯åŠ è½½
            try {
                const response = await axios.get(JSONBIN_API_URL, {
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    timeout: 10000 // 10ç§’è¶…æ—¶
                });
                
                const cloudData = response.data.record;
                
                // æ¯”è¾ƒäº‘ç«¯å’Œæœ¬åœ°æ•°æ®çš„æ—¶é—´æˆ³ï¼Œä½¿ç”¨æœ€æ–°çš„
                if (cloudData && cloudData.lastUpdate) {
                    if (!loadedData || cloudData.lastUpdate > (loadedData.lastUpdate || 0)) {
                        loadedData = cloudData;
                        cloudSuccess = true;
                        console.log('ä» JSONBin.io åŠ è½½äº†æ›´æ–°çš„æ•°æ®');
                    } else {
                        console.log('æœ¬åœ°æ•°æ®æ¯”äº‘ç«¯æ–°ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
                    }
                }
            } catch (e) {
                console.error('ä» JSONBin.io åŠ è½½æ•°æ®å¤±è´¥:', e);
                if (!loadedData) {
                    showMessage('âš ï¸ äº‘ç«¯å’Œæœ¬åœ°éƒ½æ— æ³•åŠ è½½æ•°æ®', 'warning');
                }
            }
            
            // å¦‚æœæœ‰åŠ è½½çš„æ•°æ®ï¼Œåº”ç”¨å®ƒ
            if (loadedData) {
                groupsData = loadedData.groupsData || {};
                ratingSchemes = loadedData.ratingSchemes || ratingSchemes;
                currentSchemeId = loadedData.currentSchemeId || currentSchemeId;
                currentScoringMethod = loadedData.currentScoringMethod || currentScoringMethod;
                
                // åŠ è½½ç»„å
                if (loadedData.groupNames && Array.isArray(loadedData.groupNames)) {
                    groupNames = loadedData.groupNames;
                }
                
                // åŠ è½½é‡è¯„è¯·æ±‚
                if (loadedData.reRatingRequests && Array.isArray(loadedData.reRatingRequests)) {
                    reRatingRequests = loadedData.reRatingRequests;
                }
                
                // åŠ è½½è¯„åˆ†å†å²
                if (loadedData.ratingHistory && Array.isArray(loadedData.ratingHistory)) {
                    ratingHistory = loadedData.ratingHistory;
                }
                
                // åˆå§‹åŒ–ç»„æ•°æ®
                initializeGroupsData();
                
                // ç¡®ä¿æ¯ä¸ªæ–¹æ¡ˆéƒ½æœ‰schemeLink
                Object.keys(ratingSchemes).forEach(schemeId => {
                    if (!ratingSchemes[schemeId].schemeLink) {
                        ratingSchemes[schemeId].schemeLink = generateSchemeLink(schemeId);
                    }
                });
                
                if (cloudSuccess) {
                    console.log('âœ… æ•°æ®åŒæ­¥æˆåŠŸ');
                }
            }
        }

// ç”Ÿæˆç”¨æˆ·ID - ä¸ºæ¯ä¸ªè®¾å¤‡ç”Ÿæˆç‹¬ç«‹ID
function generateUserId() {
    let userId = localStorage.getItem('ratingUserId');
    if (!userId) {
        userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        localStorage.setItem('ratingUserId', userId);
    }
    return userId;
}

// è·å–å½“å‰ç”¨æˆ·ID
function getCurrentUserId() {
    return generateUserId();
}

// æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²è¯„åˆ†æŸä¸ªç»„
function hasUserRated(groupName) {
    const userId = getCurrentUserId();
    const group = groupsData[groupName];
    if (!group || !group.scores) return false;
    
    return group.scores.some(score => score.userId === userId);
}

// è·å–å½“å‰ç”¨æˆ·çš„è¯„åˆ†
function getUserRating(groupName) {
    const userId = getCurrentUserId();
    const group = groupsData[groupName];
    if (!group || !group.scores) return null;
    
    return group.scores.find(score => score.userId === userId);
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(text, type = 'success') {
    const message = document.getElementById(type === 'info' ? 'infoMessage' : type === 'warning' ? 'warningMessage' : 'successMessage');
    message.textContent = text;
    message.style.display = 'block';
    
    setTimeout(() => {
        message.style.display = 'none';
    }, 3000);
}

// æ£€æŸ¥URL hash
function checkHash() {
    const hash = window.location.hash.replace('#', '');
    if (hash.includes('mobile')) {
        showMobilePage('group');
    } else {
        showAdminPage('home');
    }
}

// é‡ç½®æ‰€æœ‰æ•°æ®
async function resetAllData() {
    if (confirm('âš ï¸ ç¡®å®šè¦é‡ç½®æ‰€æœ‰è¯„åˆ†æ•°æ®å—ï¼Ÿæ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰è¯„åˆ†è®°å½•ï¼')) {
        // ä¿ç•™ç»„åï¼Œåªé‡ç½®è¯„åˆ†æ•°æ®
        groupNames.forEach(groupName => {
            groupsData[groupName] = { scores: [], finalScore: 0 };
        });
        
        await saveData();
        updateAllResults();
        updateGroupSelection();
        showMessage('âœ… æ‰€æœ‰æ•°æ®å·²é‡ç½®ï¼');
    }
}

// åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', init);
window.addEventListener('hashchange', function() {
    detectVersion();
    checkHash();
});

// é¡µé¢å¯è§æ€§å˜åŒ–æ—¶ä¿å­˜æ•°æ®
document.addEventListener('visibilitychange', async function() {
    if (document.visibilityState === 'hidden') {
        // é¡µé¢å³å°†éšè—æ—¶ï¼Œç¡®ä¿æ•°æ®å·²ä¿å­˜
        console.log('é¡µé¢å³å°†éšè—ï¼Œä¿å­˜æ•°æ®...');
        await saveData();
    } else if (document.visibilityState === 'visible') {
        // é¡µé¢é‡æ–°æ˜¾ç¤ºæ—¶ï¼Œé‡æ–°åŠ è½½æ•°æ®
        console.log('é¡µé¢é‡æ–°æ˜¾ç¤ºï¼ŒåŠ è½½æ•°æ®...');
        await loadData();
        updateAllResults();
        updateGroupSelection();
        if (currentVersion === 'admin') {
            updateReRatingRequestsList();
        } else {
            updateMyReRatingRequests();
        }
    }
});

// é¡µé¢å¸è½½å‰ä¿å­˜æ•°æ®
window.addEventListener('beforeunload', function() {
    console.log('é¡µé¢å³å°†å¸è½½ï¼Œä¿å­˜æ•°æ®...');
    // åŒæ­¥ä¿å­˜æ•°æ®
    saveData();
});

console.log('è¯„åˆ†ç³»ç»Ÿä»£ç åŠ è½½å®Œæˆ');
</script>
</body>
</html>
